<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>é†«å¸«äºŒéšåœ‹è€ƒæ¸¬é©—ç³»çµ± created and maintained by KMU BM112 é™³å›è±ª</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    
    /* æ–°å¢ï¼šæ¨™é¡Œå®¹å™¨æ¨£å¼ */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .header-container h1 {
      margin: 0;
      flex-grow: 1;
    }
    
    .author-info {
      color: #666;
      font-size: 14px;
      margin: 0;
      white-space: nowrap;
    }
    
    .question-block {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .question-block h3 {
      margin-top: 0;
    }
    .result {
      margin-top: 30px;
      font-weight: bold;
      white-space: pre-wrap;
    }
    .explanation {
      margin-top: 10px;
      display: none;
      color: #333;
    }
    .correct {
      color: green;
    }
    .incorrect {
      color: red;
    }
    .explanation.correct,
    .explanation.incorrect {
      color: #333 !important;
    }
    .result-correct {
      color: green;
      font-weight: bold;
    }
    .result-incorrect {
      color: red;
      font-weight: bold;
    }
    .checkbox-group {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #f9f9f9;
      display: inline-block;
      vertical-align: top;
      margin-right: 20px;
    }
    .checkbox-group label {
      display: block;
      margin: 5px 0;
      cursor: pointer;
    }
    
    /* æ–°å¢ï¼šå¢å¤§ checkbox å¤§å° */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin-right: 8px;
      transform: scale(1.2);
    }
    
    /* æ–°å¢ï¼šå¢å¤§ radio button å¤§å° */
    input[type="radio"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      margin-right: 8px;
      transform: scale(1.2);
    }
    
    .tag-selector {
      margin-bottom: 20px;
    }
    #nextBtn, #earlySubmitBtn {
      margin-top: 20px;
      margin-right: 10px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .submit-answer-btn {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
    }
    .submit-answer-btn:hover {
      background-color: #0056b3;
    }
    #nextBtn {
      background-color: #28a745;
      color: white;
      border: 1px solid #28a745;
    }
    #nextBtn:hover {
      background-color: #218838;
    }
    
    #prevBtn {
      background-color: #6c757d;
      color: white;
      border: 1px solid #6c757d;
      margin-top: 20px;
      margin-right: 10px;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    #prevBtn:hover {
      background-color: #545b62;
    }
    
    select[multiple] {
      height: 8em;
      width: 200px;
    }
    .subject-count {
      margin-left: 20px;
      margin-top: 5px;
      display: none;
    }
    .subject-count input {
      width: 50px;
      margin-left: 5px;
    }
    .question-tags {
      display: inline-block;
      margin-left: 10px;
    }
    .tag {
      display: inline-block;
      background-color: #007bff;
      color: white;
      padding: 2px 8px;
      margin: 0 2px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: normal;
    }
    .tag.year {
      background-color: #28a745;
    }
    .tag.subject {
      background-color: #dc3545;
    }
    .progress-info {
      background: #e9ecef;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .hotkey-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      font-weight: normal;
    }
    
    .step-mode-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .step-mode-content {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .step-mode .question-block {
      margin-bottom: 0;
    }
    .step-mode .progress-info {
      margin-bottom: 15px;
      text-align: center;
    }
    .step-mode-controls {
      text-align: center;
      margin-top: 20px;
    }
    .step-mode-controls button {
      margin: 0 10px;
      padding: 12px 24px;
      font-size: 16px;
    }
    #earlySubmitBtn {
      background-color: #ffc107;
      color: #212529;
      border: 1px solid #ffc107;
      border-radius: 5px;
      cursor: pointer;
    }
    #earlySubmitBtn:hover {
      background-color: #e0a800;
    }
    .hidden {
      display: none !important;
    }
    .warning-message {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: none;
    }
    css.warning-message {
 background-color: #fff3cd;
 border: 1px solid #ffeaa7;
 color: #856404;
 padding: 10px;
 margin: 10px 0;
 border-radius: 5px;
 display: none;
}

/* æ–°å¢çš„ä¸‰æ¬„å¼å¸ƒå±€æ¨£å¼ */
.selection-container {
 display: flex;
 gap: 15px;
 align-items: flex-start;
 margin: 20px 0;
 flex-wrap: wrap;
}

/* é†«å­¸(ä¸‰)å’Œé†«å­¸(å››)å¤§å€å¡Šæ¨£å¼ */
.medicine-block {
 width: 400px;
 border: 2px solid #007bff;
 border-radius: 10px;
 padding: 10px;
 background-color: #f9f9f9;
}

.medicine-block h2 {
 margin-top: 0;
 margin-bottom: 10px;
 color: #007bff;
 text-align: center;
 padding-bottom: 8px;
 border-bottom: 2px solid #007bff;
}

.medicine-block-content {
 display: flex;
 gap: 15px;
 align-items: flex-start;
}

.year-section {
 display: flex;
 gap: 20px;
}

.subject-section {
 display: flex;
 gap: 20px;
 align-items: flex-start;
}

/* èª¿æ•´checkbox-groupåœ¨æ–°å¸ƒå±€ä¸­çš„æ¨£å¼ */
.selection-container .checkbox-group {
 margin: 0;
 width: auto;
 min-width: 180px;
}

.medicine-block-content .checkbox-group {
 flex: 1;
 margin: 0;
 padding: 8px;
 border: 1px solid #ddd;
 border-radius: 5px;
 background-color: #f9f9f9;
}

/* é†«å­¸å¹´ç´šé¸æ“‡æŒ‰éˆ•æ¨£å¼ */
.grade-selector {
 display: flex;
 gap: 15px;
 margin-bottom: 20px;
 justify-content: flex-start;
}

.grade-btn {
 padding: 15px 40px;
 font-size: 18px;
 font-weight: bold;
 border: 2px solid #007bff;
 border-radius: 8px;
 background-color: #fff;
 color: #007bff;
 cursor: pointer;
 transition: all 0.3s ease;
}

.grade-btn:hover {
 background-color: #e7f3ff;
}

.grade-btn.active {
 background-color: #007bff;
 color: white;
}

/* ç”¢ç”Ÿé¡Œç›®æŒ‰éˆ•æ¨£å¼ */
.generate-button {
 padding: 20px 40px;
 font-size: 18px;
 font-weight: bold;
 background-color: #28a745;
 color: white;
 border: none;
 border-radius: 8px;
 cursor: pointer;
 margin-left: 20px;
 align-self: flex-start;
 margin-top: 30px;
 transition: all 0.3s ease;
 box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.generate-button:hover {
 background-color: #218838;
 transform: translateY(-2px);
 box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.generate-button:active {
 transform: translateY(0);
 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
 .selection-container {
   flex-direction: column;
 }
 
 .year-section {
   flex-direction: column;
   gap: 10px;
 }
 
 .checkbox-group {
   width: 100% !important;
   margin-right: 0 !important;
 }
 
 .generate-button {
   margin-left: 0;
   margin-top: 20px;
   align-self: center;
   width: 200px;
 }
}

/* è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†æ¨£å¼ */
.custom-confirm-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.custom-confirm-box {
  background: white;
  padding: 20px;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.custom-confirm-message {
  margin-bottom: 20px;
  line-height: 1.5;
  color: #333;
}

.custom-confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.custom-confirm-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  min-width: 80px;
}

.custom-confirm-cancel {
  background-color: #6c757d;
  color: white;
}

.custom-confirm-ok {
  background-color: #ffc107;
  color: #212529;
}

.custom-confirm-cancel:hover {
  background-color: #545b62;
}

.custom-confirm-ok:hover {
  background-color: #e0a800;
}

    /* è¦–è¦ºåŒ–é¸æ“‡æŒ‰éˆ•æ¨£å¼ - çµ±ä¸€ç©ºå¿ƒ/å¯¦å¿ƒæ•ˆæœ */
    .visual-checkbox {
      display: inline-block;
      padding: 10px 16px;
      margin: 4px;
      background-color: transparent;
      border: 2px solid #007bff;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      user-select: none;
      font-size: 14px;
      font-weight: 500;
      color: #007bff;
      min-height: 20px;
      box-sizing: border-box;
    }

    .visual-checkbox:hover {
      border-color: #0056b3;
      color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,123,255,0.2);
    }

    /* é¸ä¸­ç‹€æ…‹ - å¯¦å¿ƒï¼Œç¢ºä¿æ–‡å­—æ¸…æ™°å¯è¦‹ */
    .visual-checkbox.selected {
      background-color: #007bff;
      border-color: #007bff;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,123,255,0.3);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .visual-checkbox.selected:hover {
      background-color: #0056b3;
      border-color: #0056b3;
      color: white;
    }

    /* éš±è—åŸå§‹checkbox */
    .visual-checkbox input[type="checkbox"] {
      display: none;
    }

    /* ç¢ºä¿é¡Œæ•¸è¼¸å…¥æ¡†åœ¨è¦–è¦ºæŒ‰éˆ•å…§æ­£å¸¸é¡¯ç¤º */
    .visual-checkbox .subject-count {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.3);
      font-size: 12px;
    }

    .visual-checkbox.selected .subject-count {
      color: white;
      border-top-color: rgba(255,255,255,0.5);
    }

    .visual-checkbox .subject-count input {
      background-color: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px 6px;
      margin-left: 5px;
      color: #333;
      width: 50px;
    }

    .visual-checkbox.selected .subject-count input {
      background-color: white;
      border-color: #dee2e6;
    }
  
    /* æ–°å¢ï¼šåœ–ç‰‡å®¹å™¨æ¨£å¼ */
    .question-images {
      margin: 15px 0;
      text-align: left;
    }
    
    .question-images img {
      max-width: 300px;
      max-height: 250px;
      margin: 5px 10px 5px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .question-images img:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    /* åœ–ç‰‡æ”¾å¤§é¡¯ç¤ºçš„è¦†è“‹å±¤ */
    .image-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      cursor: pointer;
    }
    
    .image-overlay img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 5px;
      box-shadow: 0 4px 20px rgba(255,255,255,0.3);
    }
    
    /* éŸ¿æ‡‰å¼åœ–ç‰‡è¨­è¨ˆ */
    @media (max-width: 768px) {
      .question-images img {
        max-width: 250px;
        max-height: 200px;
      }
    }

    /* é”™é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .wrong-answers-toggle {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background-color 0.3s ease;
    }

    .wrong-answers-toggle:hover {
      background-color: #c82333;
    }

    .wrong-answers-toggle.show-all {
      background-color: #28a745;
    }

    .wrong-answers-toggle.show-all:hover {
      background-color: #218838;
    }

    /* é”™é¢˜æ˜¾ç¤ºçŠ¶æ€ä¸‹çš„æ ·å¼ */
    .question-result.hidden {
      display: none !important;
    }
    /* ç­”é¡Œè¨˜éŒ„ç®¡ç†æ¨£å¼ */
    .record-management {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .record-section {
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }
    
    .record-section h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #495057;
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin-right: 10px;
    }
    
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-btn {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s ease;
    }
    
    .file-input-btn:hover {
      background-color: #0056b3;
    }
    
    .download-record-btn {
      padding: 10px 20px;
      font-size: 14px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-right: 10px;
    }
    
    .download-record-btn:hover {
      background-color: #218838;
    }
    
    .record-status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .record-status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .record-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .record-status.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .record-stats {
      background: #e7f3ff;
      border: 1px solid #b8daff;
      border-radius: 5px;
      padding: 10px;
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.5;
    }

    /* ç·Šæ¹Šå·¦å³åˆ†å‰²å¸ƒå±€ */
    .record-management {
      display: flex;
      gap: 15px;
      margin: 15px 0;
      padding: 15px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
    }
    
    .record-section {
      flex: 1;
      min-width: 0; /* é˜²æ­¢ flex é …ç›®æº¢å‡º */
    }
    
    .record-section h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #495057;
    }
    
    /* æª”æ¡ˆè¼¸å…¥å€åŸŸ */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin-bottom: 8px;
    }
    
    .file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-btn {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s ease;
      min-width: 100px;
    }
    
    .file-input-btn:hover {
      background-color: #0056b3;
    }
    
    /* ä¸‹è¼‰æŒ‰éˆ•å®¹å™¨ */
    .download-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* ç›®å‰ä½œç­”è¨˜éŒ„æŒ‰éˆ• - ç¶ è‰² */
    .current-record-btn {
      padding: 8px 16px;
      font-size: 13px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }
    
    .current-record-btn:hover {
      background-color: #218838;
    }
    
    /* æ­·å²å®Œæ•´è¨˜éŒ„æŒ‰éˆ• - è—è‰² */
    .history-record-btn {
      padding: 8px 16px;
      font-size: 13px;
      background-color: #6c757d;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }
    
    .history-record-btn:not(:disabled) {
      background-color: #007bff;
    }
    
    .history-record-btn:not(:disabled):hover {
      background-color: #0056b3;
    }
    
    .history-record-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    /* ç‹€æ…‹æç¤º */
    .record-status {
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 3px;
      margin-top: 5px;
    }
    
    .record-status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .record-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .record-status.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    @media (max-width: 480px) {
      .record-management {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }
      
      .download-buttons {
        flex-direction: row;
        gap: 8px;
      }
      
      .current-record-btn, .history-record-btn {
        flex: 1;
        min-width: 80px;
        font-size: 12px;
        padding: 6px 8px;
      }
    }
  
    /* è¦–è¦ºåŒ–åŠŸèƒ½æ¨£å¼ */
    .visualization-btn {
      padding: 8px 16px;
      font-size: 13px;
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 120px;
      text-align: center;
    }
    
    .visualization-btn:hover {
      background-color: #138496;
      transform: translateY(-1px);
    }
    
    .visualization-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }

    /* è¦–è¦ºåŒ–å½ˆå‡ºè¦–çª—æ¨£å¼ */
    .visualization-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
      box-sizing: border-box;
    }

    .visualization-content {
      background: white;
      border-radius: 12px;
      width: 98%;
      max-width: 1800px;
      height: 90%;
      max-height: 800px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .visualization-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .visualization-header h2 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 300;
    }

    .close-visualization {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }

    .close-visualization:hover {
      background-color: rgba(255,255,255,0.2);
    }

    .visualization-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f5f7fa;
    }

    .exam-section {
      background: white;
      border-radius: 12px;
      margin-bottom: 25px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .exam-header {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.3em;
      font-weight: 600;
    }

    .exam-header.medicine-2 {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
    }

    .year-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0;
    }

    .year-column {
      border-right: 1px solid #e1e8ed;
      min-height: 300px;
    }

    .year-column:last-child {
      border-right: none;
    }

    .year-header {
      background-color: #f8f9fa;
      padding: 12px 15px;
      text-align: center;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #e1e8ed;
      font-size: 0.95em;
    }

    .questions-container {
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
    }

    .question-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 8px;
      margin-bottom: 2px;
      border-radius: 4px;
      transition: all 0.2s ease;
      font-size: 0.85em;
    }

    .question-row:hover {
      background-color: #f8f9fa;
    }

    .question-number {
      font-weight: 500;
      color: #495057;
      min-width: 50px;
      font-size: 0.8em;
    }

    .answer-history {
      display: flex;
      gap: 2px;
      align-items: center;
    }

    .answer-symbol {
      font-size: 1em;
      line-height: 1;
    }

    .correct-symbol {
      color: #28a745;
    }

    .incorrect-symbol {
      color: #dc3545;
    }

    .empty-state {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 50px 20px;
    }



    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 1400px) {
      .year-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    @media (max-width: 1100px) {
      .year-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .year-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .visualization-content {
        width: 98%;
        height: 95%;
      }
    }

    @media (max-width: 600px) {
      .year-grid {
        grid-template-columns: 1fr;
      }
      
      .visualization-content {
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
      
      .questions-container {
        max-height: 350px;
      }
    }

    /* è‡ªè¨‚æ»¾å‹•æ¢ */
    .questions-container::-webkit-scrollbar,
    .visualization-body::-webkit-scrollbar {
      width: 6px;
    }

    .questions-container::-webkit-scrollbar-track,
    .visualization-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .questions-container::-webkit-scrollbar-thumb,
    .visualization-body::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .questions-container::-webkit-scrollbar-thumb:hover,
    .visualization-body::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

  
    /* ç€è¦½æ¨¡å¼æ¨£å¼ */
    .question-result.browse-mode {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .question-result.browse-mode:nth-child(even) {
      background: #ffffff;
    }
    
    /* ç€è¦½æ¨¡å¼èªªæ˜å€å¡Š */
    .browse-mode-info {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 2px solid #81c784;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .browse-mode-info h3 {
      color: #2e7d32;
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }
    
    .browse-mode-info p {
      color: #424242;
      margin: 0;
      font-size: 1em;
    }

    /* é¦–é è¨˜éŒ„ç®¡ç†å€åŸŸæ¨£å¼ */
    .homepage-record-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    
    .homepage-record-section h3 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 18px;
      font-weight: 600;
    }
    
    .homepage-record-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .homepage-file-input-wrapper {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    
    .homepage-file-input {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .homepage-file-btn {
      padding: 12px 24px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }
    
    .homepage-file-btn:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    
    .homepage-visualization-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      background-color: #17a2b8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }
    
    .homepage-visualization-btn:hover:not(:disabled) {
      background-color: #138496;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(23,162,184,0.3);
    }
    
    .homepage-visualization-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }
    
    .homepage-record-status {
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 5px;
      display: inline-block;
    }
    
    .homepage-record-status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .homepage-record-status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .homepage-record-status.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .homepage-divider {
      height: 2px;
      background: linear-gradient(to right, #dee2e6, #6c757d, #dee2e6);
      margin: 25px 0;
      border: none;
    }
    
    /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    @media (max-width: 600px) {
      .homepage-record-buttons {
        flex-direction: column;
        gap: 12px;
      }
      
      .homepage-file-btn,
      .homepage-visualization-btn {
        width: 100%;
        max-width: 200px;
      }
    /* ç°¡åŒ–çš„å›é¥‹è¡¨å–®æ¨£å¼ */
    .feedback-link {
      display: inline-block;
      text-align: center;
      margin: 10px 0 5px 0;
      font-size: 14px;
    }
    
    .feedback-link a {
      color: #007bff;
      text-decoration: none;
      padding: 2px 8px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }
    
    .feedback-link a:hover {
      background-color: #f8f9fa;
      text-decoration: underline;
    }

    }
</style>
</head>
<body>
  <div class="header-container" id="headerSection">
    <h1>é†«å¸«äºŒéšåœ‹è€ƒæ¸¬é©—ç³»çµ±</h1>
    <p class="author-info">created and maintained by KMU BM112 é™³å›è±ª</p>
  </div>
<div class="tag-selector" id="setupSection">

  <!-- é¦–é è¨˜éŒ„æª”ç®¡ç†å€åŸŸ -->
  <div class="homepage-record-section" id="homepageRecordSection">
    <h3>ğŸ“Š ç­”é¡Œè¨˜éŒ„ç®¡ç†</h3>
    <div class="homepage-record-buttons">
      <div class="homepage-file-input-wrapper">
        <input type="file" accept=".json" class="homepage-file-input" onchange="loadHomepageRecord(this.files[0])">
        <button class="homepage-file-btn">
          ğŸ“‚ è¼‰å…¥è¨˜éŒ„æª”
        </button>
      </div>
      <button id="homepageVisualizationBtn" class="homepage-visualization-btn" onclick="openHomepageVisualization()" disabled>
        ğŸ“Š è¦–è¦ºåŒ–åˆ†æ
      </button>
    </div>
    <div class="homepage-record-status info" id="homepageRecordStatus">å°šæœªè¼‰å…¥è¨˜éŒ„æª”æ¡ˆ</div>
  </div>
  <div class="feedback-link">
    ğŸ’¬ <a href="https://forms.gle/XdYNQoRgq9PBRm658" target="_blank">ç³»çµ±å›é¥‹èˆ‡å»ºè­°</a>
  </div>

  
  <hr class="homepage-divider">
  <label>é¸æ“‡æ¨¡å¼ï¼š</label>
    <select id="mode">
      <option value="step">ä¸€é¡Œä¸€é¡Œä½œç­”ä¸¦é¡¯ç¤ºè©³è§£</option>
      <option value="all">å…¨éƒ¨ä½œç­”å¾Œé¡¯ç¤ºè©³è§£</option>
      <option value="browse">ç€è¦½æ¨¡å¼ - ç›´æ¥æŸ¥çœ‹é¡Œç›®èˆ‡è©³è§£</option>
    </select>
    <br><br>
    <label>å‡ºé¡Œé †åºï¼š</label>
    <select id="questionOrder">
      <option value="random">éš¨æ©Ÿé †åº</option>
      <option value="sequential">ç…§åŸå§‹é †åº</option>
    </select>
    <br><br>
    <!-- ä¿®æ”¹å¾Œçš„é¸æ“‡å€åŸŸ - é†«å­¸(ä¸‰)å’Œé†«å­¸(å››)åˆ†åˆ¥ç¨ç«‹ -->
    <label>é¸æ“‡å¹´ä»½å’Œç§‘ç›®ï¼š</label>
    
    <!-- æ–°å¢ï¼šé†«å­¸å¹´ç´šé¸æ“‡æŒ‰éˆ• -->
    <div class="grade-selector">
      <button id="med3Btn" class="grade-btn active" onclick="switchGrade('med3')">é†«å­¸(ä¸‰)</button>
      <button id="med4Btn" class="grade-btn" onclick="switchGrade('med4')">é†«å­¸(å››)</button>
      <button id="med5Btn" class="grade-btn" onclick="switchGrade('med5')">é†«å­¸(äº”)</button>
      <button id="med6Btn" class="grade-btn" onclick="switchGrade('med6')">é†«å­¸(å…­)</button>
    </div>
    
    <div class="selection-container">
      <!-- é†«å­¸(ä¸‰)å¤§å€å¡Š -->
      <div class="medicine-block" id="med3Block">
        <h2>é†«å­¸(ä¸‰)</h2>
        <div class="medicine-block-content">
          <!-- å¹´ä»½é¸æ“‡ -->
          <div class="checkbox-group">
            <strong>é¸æ“‡å¹´ä»½</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="all3" onchange="handleSelectAll('year3')">å…¨é¸</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-2-3">114-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-1-3">114-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-2-3">113-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-1-3">113-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-2-3">112-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-1-3">112-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-2-3">111-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-1-3">111-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-2-3">110-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-1-3">110-1</div><br>
          </div>
          
          <!-- ç§‘ç›®é¸æ“‡ -->
          <div class="checkbox-group" id="medicine3-subjects">
            <strong>é¸æ“‡ç§‘ç›®</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="medicine3-all" onchange="handleSelectAll('medicine3-subject')">å…¨é¸</div>
            <div class="subject-count" id="count-medicine3-all-subjects" style="display:none;">
              ç¸½é¡Œæ•¸ï¼š<input type="number" value="80" min="1" max="200">
            </div>
            <br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å¿ƒè‡Ÿå…§ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">å¿ƒè‡Ÿå…§ç§‘<div class="subject-count" id="count-medicine3-å¿ƒè‡Ÿå…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="èƒ¸è…”å…§ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">èƒ¸è…”å…§ç§‘<div class="subject-count" id="count-medicine3-èƒ¸è…”å…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è…¸èƒƒå…§ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">è…¸èƒƒå…§ç§‘<div class="subject-count" id="count-medicine3-è…¸èƒƒå…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è‚è†½å…§ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">è‚è†½å…§ç§‘<div class="subject-count" id="count-medicine3-è‚è†½å…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="æ–°é™³ä»£è¬ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">æ–°é™³ä»£è¬ç§‘<div class="subject-count" id="count-medicine3-æ–°é™³ä»£è¬ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è…è‡Ÿå…§ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">è…è‡Ÿå…§ç§‘<div class="subject-count" id="count-medicine3-è…è‡Ÿå…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="æ„ŸæŸ“ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">æ„ŸæŸ“ç§‘<div class="subject-count" id="count-medicine3-æ„ŸæŸ“ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="é¢¨æ¿•å…ç–«ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">é¢¨æ¿•å…ç–«ç§‘<div class="subject-count" id="count-medicine3-é¢¨æ¿•å…ç–«ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è¡€æ¶²ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">è¡€æ¶²ç§‘<div class="subject-count" id="count-medicine3-è¡€æ¶²ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è…«ç˜¤ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">è…«ç˜¤ç§‘<div class="subject-count" id="count-medicine3-è…«ç˜¤ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å®¶é†«ç§‘" onchange="toggleSubjectCount(this, 'medicine3')">å®¶é†«ç§‘<div class="subject-count" id="count-medicine3-å®¶é†«ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
          </div>
        </div>
      </div>
      
      <!-- é†«å­¸(å››)å¤§å€å¡Š -->
      <div class="medicine-block" id="med4Block" style="display: none;">
        <h2>é†«å­¸(å››)</h2>
        <div class="medicine-block-content">
          <!-- å¹´ä»½é¸æ“‡ -->
          <div class="checkbox-group">
            <strong>é¸æ“‡å¹´ä»½</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="all4" onchange="handleSelectAll('year4')">å…¨é¸</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-2-4">114-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-1-4">114-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-2-4">113-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-1-4">113-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-2-4">112-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-1-4">112-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-2-4">111-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-1-4">111-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-2-4">110-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-1-4">110-1</div><br>
          </div>
          
          <!-- ç§‘ç›®é¸æ“‡ -->
          <div class="checkbox-group" id="medicine4-subjects">
            <strong>é¸æ“‡ç§‘ç›®</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="medicine4-all" onchange="handleSelectAll('medicine4-subject')">å…¨é¸</div>
            <div class="subject-count" id="count-medicine4-all-subjects" style="display:none;">
              ç¸½é¡Œæ•¸ï¼š<input type="number" value="80" min="1" max="200">
            </div>
            <br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å°å…’ç§‘" onchange="toggleSubjectCount(this, 'medicine4')">å°å…’ç§‘<div class="subject-count" id="count-medicine4-å°å…’ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="çš®è†šç§‘" onchange="toggleSubjectCount(this, 'medicine4')">çš®è†šç§‘<div class="subject-count" id="count-medicine4-çš®è†šç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="ç²¾ç¥ç§‘" onchange="toggleSubjectCount(this, 'medicine4')">ç²¾ç¥ç§‘<div class="subject-count" id="count-medicine4-ç²¾ç¥ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="ç¥ç¶“å…§ç§‘" onchange="toggleSubjectCount(this, 'medicine4')">ç¥ç¶“å…§ç§‘<div class="subject-count" id="count-medicine4-ç¥ç¶“å…§ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
          </div>
        </div>
      </div>
      
      <!-- é†«å­¸(äº”)å¤§å€å¡Š -->
      <div class="medicine-block" id="med5Block" style="display: none;">
        <h2>é†«å­¸(äº”)</h2>
        <div class="medicine-block-content">
          <!-- å¹´ä»½é¸æ“‡ -->
          <div class="checkbox-group">
            <strong>é¸æ“‡å¹´ä»½</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="all5" onchange="handleSelectAll('year5')">å…¨é¸</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-2-5">114-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-1-5">114-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-2-5">113-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-1-5">113-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-2-5">112-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-1-5">112-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-2-5">111-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-1-5">111-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-2-5">110-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-1-5">110-1</div><br>
          </div>
          
          <!-- ç§‘ç›®é¸æ“‡ -->
          <div class="checkbox-group" id="medicine5-subjects">
            <strong>é¸æ“‡ç§‘ç›®</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="medicine5-all" onchange="handleSelectAll('medicine5-subject')">å…¨é¸</div>
            <div class="subject-count" id="count-medicine5-all-subjects" style="display:none;">
              ç¸½é¡Œæ•¸ï¼š<input type="number" value="80" min="1" max="200">
            </div>
            <br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å¤–ç§‘æ¦‚è«–" onchange="toggleSubjectCount(this, 'medicine5')">å¤–ç§‘æ¦‚è«–<div class="subject-count" id="count-medicine5-å¤–ç§‘æ¦‚è«–">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="ç¥ç¶“å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">ç¥ç¶“å¤–ç§‘<div class="subject-count" id="count-medicine5-ç¥ç¶“å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å¿ƒè‡Ÿå¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">å¿ƒè‡Ÿå¤–ç§‘<div class="subject-count" id="count-medicine5-å¿ƒè‡Ÿå¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å¤§è…¸ç›´è…¸å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">å¤§è…¸ç›´è…¸å¤–ç§‘<div class="subject-count" id="count-medicine5-å¤§è…¸ç›´è…¸å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å…§åˆ†æ³Œå¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">å…§åˆ†æ³Œå¤–ç§‘<div class="subject-count" id="count-medicine5-å…§åˆ†æ³Œå¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="æ•´å½¢å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">æ•´å½¢å¤–ç§‘<div class="subject-count" id="count-medicine5-æ•´å½¢å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="èƒƒå¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">èƒƒå¤–ç§‘<div class="subject-count" id="count-medicine5-èƒƒå¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å°è…¸å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">å°è…¸å¤–ç§‘<div class="subject-count" id="count-medicine5-å°è…¸å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è‚è‡Ÿå¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">è‚è‡Ÿå¤–ç§‘<div class="subject-count" id="count-medicine5-è‚è‡Ÿå¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è†½é“å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">è†½é“å¤–ç§‘<div class="subject-count" id="count-medicine5-è†½é“å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="èƒ°è‡Ÿå¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">èƒ°è‡Ÿå¤–ç§‘<div class="subject-count" id="count-medicine5-èƒ°è‡Ÿå¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="ä¹³æˆ¿å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">ä¹³æˆ¿å¤–ç§‘<div class="subject-count" id="count-medicine5-ä¹³æˆ¿å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="èƒ¸è…”å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">èƒ¸è…”å¤–ç§‘<div class="subject-count" id="count-medicine5-èƒ¸è…”å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å°å…’å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">å°å…’å¤–ç§‘<div class="subject-count" id="count-medicine5-å°å…’å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="æ³Œå°¿å¤–ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">æ³Œå°¿å¤–ç§‘<div class="subject-count" id="count-medicine5-æ³Œå°¿å¤–ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="éª¨ç§‘" onchange="toggleSubjectCount(this, 'medicine5')">éª¨ç§‘<div class="subject-count" id="count-medicine5-éª¨ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
          </div>
        </div>
      </div>
      
      <!-- é†«å­¸(å…­)å¤§å€å¡Š -->
      <div class="medicine-block" id="med6Block" style="display: none;">
        <h2>é†«å­¸(å…­)</h2>
        <div class="medicine-block-content">
          <!-- å¹´ä»½é¸æ“‡ -->
          <div class="checkbox-group">
            <strong>é¸æ“‡å¹´ä»½</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="all6" onchange="handleSelectAll('year6')">å…¨é¸</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-2-6">114-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="114-1-6">114-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-2-6">113-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="113-1-6">113-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-2-6">112-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="112-1-6">112-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-2-6">111-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="111-1-6">111-1</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-2-6">110-2</div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="110-1-6">110-1</div><br>
          </div>
          
          <!-- ç§‘ç›®é¸æ“‡ -->
          <div class="checkbox-group" id="medicine6-subjects">
            <strong>é¸æ“‡ç§‘ç›®</strong><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="medicine6-all" onchange="handleSelectAll('medicine6-subject')">å…¨é¸</div>
            <div class="subject-count" id="count-medicine6-all-subjects" style="display:none;">
              ç¸½é¡Œæ•¸ï¼š<input type="number" value="80" min="1" max="200">
            </div>
            <br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å©¦ç”¢ç§‘" onchange="toggleSubjectCount(this, 'medicine6')">å©¦ç”¢ç§‘<div class="subject-count" id="count-medicine6-å©¦ç”¢ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="çœ¼ç§‘" onchange="toggleSubjectCount(this, 'medicine6')">çœ¼ç§‘<div class="subject-count" id="count-medicine6-çœ¼ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="å¾©å¥ç§‘" onchange="toggleSubjectCount(this, 'medicine6')">å¾©å¥ç§‘<div class="subject-count" id="count-medicine6-å¾©å¥ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="éº»é†‰ç§‘" onchange="toggleSubjectCount(this, 'medicine6')">éº»é†‰ç§‘<div class="subject-count" id="count-medicine6-éº»é†‰ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
            <div class="visual-checkbox" onclick="toggleVisualCheckbox(this)"><input type="checkbox" value="è€³é¼»å–‰ç§‘" onchange="toggleSubjectCount(this, 'medicine6')">è€³é¼»å–‰ç§‘<div class="subject-count" id="count-medicine6-è€³é¼»å–‰ç§‘">
                é¡Œæ•¸ï¼š<input type="number" value="1" min="1" max="10">
              </div></div><br>
          </div>
        </div>
      </div>
      
      <!-- ç”¢ç”Ÿé¡Œç›®æŒ‰éˆ• -->
      <button class="generate-button" onclick="startQuiz()">ç”¢ç”Ÿé¡Œç›®</button>
    </div>
  </div>

  <!-- æ­¥é©Ÿæ¨¡å¼çš„é€²åº¦é¡¯ç¤º -->
  <div class="progress-info hidden" id="progressInfo">
    <strong>é€²åº¦ï¼šç¬¬ <span id="currentQuestionNum">1</span> é¡Œ / å…± <span id="totalQuestions">0</span> é¡Œ</strong>
    <div class="hotkey-info">å¿«æ·éµï¼šAâ†‘ã€Bâ†ã€Câ†“ã€Dâ†’ ã€æäº¤ç­”æ¡ˆ/ä¸‹ä¸€é¡Œï¼šç©ºç™½éµ</div>
  </div>

  <div id="quiz"></div>
  
  <!-- ä¸€èˆ¬æ¨¡å¼çš„æäº¤æŒ‰éˆ• -->
  <button id="submitBtn" onclick="submitQuiz()" class="hidden">æäº¤æ¸¬é©—</button>
  
  <!-- æ­¥é©Ÿæ¨¡å¼çš„æ§åˆ¶æŒ‰éˆ• -->
  <div class="step-mode-controls hidden" id="stepControls">
    <button id="prevBtn" onclick="prevQuestion()" style="display:none">å›ä¸Šé¡Œ</button>
    <button id="nextBtn" onclick="nextQuestion()" style="display:none">ä¸‹ä¸€é¡Œ</button>
    <button id="earlySubmitBtn" onclick="earlySubmit()" style="display:none">ææ—©äº¤å·</button>
  </div>
  
  <div class="result" id="result"></div>

  <script>
    // ç­”æ¡ˆæ¯”è¼ƒå‡½æ•¸ - æ”¯æ´å–®é¸å’Œå¤šé¸
    function isAnswerCorrect(userAnswer, correctAnswer) {
      if (!userAnswer) return false;
      
      // è™•ç†æ­£ç¢ºç­”æ¡ˆæ ¼å¼
      let correctAnswers = [];
      if (Array.isArray(correctAnswer)) {
        correctAnswers = correctAnswer;
      } else {
        correctAnswers = [correctAnswer];
      }
      
      // æª¢æŸ¥ç”¨æˆ¶ç­”æ¡ˆæ˜¯å¦åœ¨æ­£ç¢ºç­”æ¡ˆåˆ—è¡¨ä¸­
      return correctAnswers.includes(userAnswer);
    }

    // æ ¼å¼åŒ–æ­£ç¢ºç­”æ¡ˆé¡¯ç¤º
    function formatCorrectAnswer(answer, options) {
      if (Array.isArray(answer)) {
        return '\n' + answer.map(a => a + '. ' + options[a]).join('\n');
      } else {
        return '\n' + answer + '. ' + options[answer];
      }
    }

    // æ ¼å¼åŒ–ç”¨æˆ¶ç­”æ¡ˆé¡¯ç¤º
    function formatUserAnswer(userAnswer, options) {
      if (!userAnswer) return '\næœªä½œç­”';
      return '\n' + userAnswer + '. ' + options[userAnswer];
    }

    // è¦–è¦ºåŒ–checkboxåˆ‡æ›å‡½æ•¸
    function toggleVisualCheckbox(element) {
      // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨è¼¸å…¥æ¡†ä¸Šï¼Œå¦‚æœæ˜¯å‰‡ä¸è™•ç†
      if (event.target.tagName === 'INPUT' && event.target.type === 'number') {
        return;
      }
      
      const checkbox = element.querySelector('input[type="checkbox"]');
      const isCurrentlyChecked = checkbox.checked;
      
      // åˆ‡æ›checkboxç‹€æ…‹
      checkbox.checked = !isCurrentlyChecked;
      
      // æ›´æ–°è¦–è¦ºæ¨£å¼
      updateSingleVisualStyle(element);
      
      // è§¸ç™¼åŸæœ‰çš„onchangeäº‹ä»¶
      if (checkbox.onchange) {
        checkbox.onchange();
      }
      
      // è™•ç†ç‰¹æ®Šæƒ…æ³
      const value = checkbox.value;
      if (value === 'all3' || value === 'all4' || value === 'all5' || value === 'all6' || 
          value === 'medicine3-all' || value === 'medicine4-all' || value === 'medicine5-all' || value === 'medicine6-all') {
        setTimeout(() => updateVisualStyles(), 10);
      } else if (subjectTags.includes(value)) {
        // toggleSubjectCountå‡½æ•¸å·²ç¶“åœ¨onchangeä¸­è™•ç†
      }
    }

    // æ›´æ–°å–®å€‹æŒ‰éˆ•çš„è¦–è¦ºæ¨£å¼
    function updateSingleVisualStyle(element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      if (checkbox.checked) {
        element.classList.add('selected');
      } else {
        element.classList.remove('selected');
      }
    }

    // æ›´æ–°æ‰€æœ‰è¦–è¦ºæ¨£å¼çš„è¼”åŠ©å‡½æ•¸
    function updateVisualStyles() {
      document.querySelectorAll('.visual-checkbox').forEach(element => {
        updateSingleVisualStyle(element);
      });
    }


// è‡ªå®šç¾©ç¢ºèªå°è©±æ¡†å‡½æ•¸
    function customConfirm(message) {
      return new Promise((resolve) => {
        // å‰µå»ºå°è©±æ¡†HTML
        const overlay = document.createElement('div');
        overlay.className = 'custom-confirm-overlay';
        overlay.innerHTML = `
          <div class="custom-confirm-box">
            <div class="custom-confirm-message">${message}</div>
            <div class="custom-confirm-buttons">
              <button class="custom-confirm-btn custom-confirm-ok" onclick="handleConfirmResponse(true)">ç¢ºå®š</button>
              <button class="custom-confirm-btn custom-confirm-cancel" onclick="handleConfirmResponse(false)">å–æ¶ˆ</button>
            </div>
          </div>
        `;
        
        // æ·»åŠ åˆ°é é¢
        document.body.appendChild(overlay);
        
        // å…¨åŸŸè®Šæ•¸ä¾†è™•ç†å›æ‡‰
        window.confirmResolve = resolve;
      });
    }

    // è™•ç†ç¢ºèªå°è©±æ¡†å›æ‡‰
    function handleConfirmResponse(result) {
      const overlay = document.querySelector('.custom-confirm-overlay');
      if (overlay) {
        overlay.remove();
      }
      if (window.confirmResolve) {
        window.confirmResolve(result);
        window.confirmResolve = null;
      }
    }
    const questions = [
      {
        id: 1142201,
        question: "1. ä¸‹åˆ—é‚£ä¸€ç¨®ç´°èŒæ˜¯å…¼æ€§å­æ°§èŒï¼ˆfacultative anaerobesï¼‰ï¼Ÿ",
        options: {
          A: "å¤§è…¸æ¡¿èŒï¼ˆEscherichia coliï¼‰",
          B: "çµæ ¸æ¡¿èŒï¼ˆMycobacteria tuberculosisï¼‰",
          C: "ç ´å‚·é¢¨æ¡¿èŒï¼ˆClostridium tetaniï¼‰",
          D: "è‚‰æ¯’æ¡¿èŒï¼ˆClostridium botulinumï¼‰"
        },
        answer: "A",
        explanation: "è§£é¡Œé—œéµæ˜¯å€åˆ†ç´°èŒçš„æ°§æ°£éœ€æ±‚é¡å‹ï¼Œå…¼æ€§å­æ°§èŒæ—¢èƒ½åœ¨æœ‰æ°§ä¹Ÿèƒ½åœ¨ç„¡æ°§ç’°å¢ƒä¸‹ç”Ÿé•·ã€‚<br>(A) æ­£ç¢ºï¼Œå¤§è…¸æ¡¿èŒï¼ˆEscherichia coliï¼‰æ˜¯å…¸å‹çš„å…¼æ€§å­æ°§èŒï¼Œæ—¢èƒ½é€²è¡Œæœ‰æ°§å‘¼å¸ä¹Ÿèƒ½é€²è¡Œç™¼é…µ<br>(B) éŒ¯èª¤ï¼Œçµæ ¸æ¡¿èŒï¼ˆMycobacteria tuberculosisï¼‰æ˜¯çµ•å°éœ€æ°§èŒï¼ˆobligate aerobeï¼‰ï¼Œéœ€è¦æ°§æ°£æ‰èƒ½ç”Ÿé•·<br>(C) éŒ¯èª¤ï¼Œç ´å‚·é¢¨æ¡¿èŒï¼ˆClostridium tetaniï¼‰æ˜¯çµ•å°å­æ°§èŒï¼ˆobligate anaerobeï¼‰ï¼Œæ°§æ°£å°å…¶æœ‰æ¯’<br>(D) éŒ¯èª¤ï¼Œè‚‰æ¯’æ¡¿èŒï¼ˆClostridium botulinumï¼‰æ˜¯çµ•å°å­æ°§èŒï¼Œç„¡æ³•åœ¨æœ‰æ°§ç’°å¢ƒä¸‹ç”Ÿé•·",
        tags: [
          "114-2(äºŒ)",
          "å¾®ç”Ÿç‰©"
        ],
        group_id: "group_4300"
      },
      {
        id: 1142202,
        question: "2. å¤§è…¸æ¡¿èŒO157:H7å¸¸å¼•èµ·å‡ºè¡€æ€§è…¹ç€‰ï¼ŒH7çš„HæŒ‡çš„æ˜¯ç´°èŒçš„é‚£ä¸€éƒ¨åˆ†ï¼Ÿ",
        options: {
          A: "é­æ¯›ï¼ˆflagellaï¼‰",
          B: "è„‚å¤šé†£ï¼ˆlipopolysaccharideï¼‰",
          C: "æ ¸å¿ƒå¤šé†£ï¼ˆcore polysaccharideï¼‰",
          D: "è¢è†œï¼ˆcapsuleï¼‰"
        },
        answer: "A",
        explanation: "è§£é¡Œé—œéµæ˜¯äº†è§£ç´°èŒæŠ—åŸå‘½åç³»çµ±ï¼ŒOä»£è¡¨é«”æŠ—åŸï¼ŒHä»£è¡¨é­æ¯›æŠ—åŸã€‚<br>(A) æ­£ç¢ºï¼ŒH7çš„HæŒ‡çš„æ˜¯é­æ¯›ï¼ˆflagellaï¼‰æŠ—åŸï¼Œ7æ˜¯ç‰¹å®šçš„è¡€æ¸…å‹ç·¨è™Ÿ<br>(B) éŒ¯èª¤ï¼Œè„‚å¤šé†£ï¼ˆlipopolysaccharideï¼‰å°æ‡‰çš„æ˜¯OæŠ—åŸï¼Œä¸æ˜¯HæŠ—åŸ<br>(C) éŒ¯èª¤ï¼Œæ ¸å¿ƒå¤šé†£ï¼ˆcore polysaccharideï¼‰æ˜¯è„‚å¤šé†£çš„çµ„æˆéƒ¨åˆ†ï¼Œèˆ‡HæŠ—åŸç„¡é—œ<br>(D) éŒ¯èª¤ï¼Œè¢è†œï¼ˆcapsuleï¼‰å°æ‡‰çš„æ˜¯KæŠ—åŸï¼Œä¸æ˜¯HæŠ—åŸ",
        tags: [
          "114-2(äºŒ)",
          "å¾®ç”Ÿç‰©"
        ],
        group_id: "group_4301"
      },
      {
        id: 1142203,
        question: "3. é—œæ–¼éˆç«¯èºæ—‹é«”ç—…ï¼ˆleptospirosisï¼‰ä¹‹æ•˜è¿°ï¼Œä¸‹åˆ—ä½•è€…æœ€ä¸é©ç•¶ï¼Ÿ",
        options: {
          A: "ç—…åŸé«”æ˜¯Leptospira interrogansï¼Œç‚ºçµ•å°å—œæ°§èŒï¼ˆobligate aerobeï¼‰ï¼Œå®¹æ˜“åŸ¹é¤Š",
          B: "é›–å…·æœ‰ä¸»å‹•ç©¿é€é»è†œçš„èƒ½åŠ›ï¼Œä½†ä¸æœƒé€éæ€§è¡Œç‚ºå‚³æŸ“",
          C: "é€šå¸¸ä»¥doxycyclineæ²»ç™‚æˆ–é é˜²",
          D: "åš™é½’é¡å‹•ç‰©æ˜¯ä¸»è¦çš„ä¿èŒå®¿ä¸»ï¼ˆreservoirï¼‰ï¼Œå…¶å¸¶èŒçš„å°¿æ¶²æœƒæ±¡æŸ“åœŸå£¤"
        },
        answer: "A",
        explanation: "è§£é¡Œé—œéµæ˜¯äº†è§£éˆç«¯èºæ—‹é«”çš„ç”Ÿç‰©ç‰¹æ€§ï¼Œç‰¹åˆ¥æ˜¯å…¶æ°§æ°£éœ€æ±‚å’ŒåŸ¹é¤Šé›£æ˜“åº¦ã€‚<br>(A) éŒ¯èª¤ï¼ŒLeptospira interrogansç¢ºå¯¦æ˜¯çµ•å°å—œæ°§èŒï¼Œä½†å®ƒä¸å®¹æ˜“åŸ¹é¤Šï¼Œéœ€è¦ç‰¹æ®ŠåŸ¹é¤ŠåŸºä¸”ç”Ÿé•·ç·©æ…¢<br>(B) æ­£ç¢ºï¼Œéˆç«¯èºæ—‹é«”é›–èƒ½ç©¿é€é»è†œï¼Œä½†ä¸»è¦é€šéæ¥è§¸æ±¡æŸ“çš„æ°´æˆ–åœŸå£¤å‚³æ’­ï¼Œä¸ç¶“æ€§è¡Œç‚ºå‚³æŸ“<br>(C) æ­£ç¢ºï¼Œdoxycyclineç¢ºå¯¦æ˜¯æ²»ç™‚å’Œé é˜²éˆç«¯èºæ—‹é«”ç—…çš„é¦–é¸è—¥ç‰©<br>(D) æ­£ç¢ºï¼Œåš™é½’é¡å‹•ç‰©æ˜¯ä¸»è¦ä¿èŒå®¿ä¸»ï¼Œå…¶å°¿æ¶²æ±¡æŸ“ç’°å¢ƒæ˜¯é‡è¦å‚³æŸ“æº",
        tags: [
          "114-2(äºŒ)",
          "å¾®ç”Ÿç‰©"
        ],
        group_id: "group_4302"
      }
  ];
    let quiz = [];
    let currentQuestion = 0;
    let correct = 0;
    let isStepMode = false;
    let canUseSpacebar = false; // æ§åˆ¶æ˜¯å¦å¯ä»¥ä½¿ç”¨ç©ºç™½éµ
    let hasWarned = false; // è¿½è¹¤æ˜¯å¦å·²ç¶“è­¦å‘Šéæœªé¸æ“‡é¸é …
    let showingWrongAnswersOnly = false;
    let wrongQuestionIndices = [];
    // ç­”é¡Œè¨˜éŒ„ç›¸é—œè®Šæ•¸
    let userProgress = {
      metadata: {
        version: "1.0",
        lastUpdated: null,
        totalAttempted: 0
      }
    };  // å„²å­˜æ¯å€‹é¡Œç›®IDå°æ‡‰çš„ç­”é¡Œè¨˜éŒ„é™£åˆ—
    let hasLoadedProgress = false;  // æ˜¯å¦å·²è¼‰å…¥è¨˜éŒ„
    // è¨˜éŒ„æª”æ›´æ–°ç›¸é—œè®Šæ•¸
    let loadedFileName = '';  // è¼‰å…¥çš„æª”æ¡ˆåç¨±

    // è¼‰å…¥ç­”é¡Œè¨˜éŒ„
    function loadUserProgress(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const loadedProgress = JSON.parse(e.target.result);
          
          // é©—è­‰æª”æ¡ˆæ ¼å¼
          if (!loadedProgress.metadata) {
            throw new Error("æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼Œç¼ºå°‘metadata");
          }
          
          // æ™ºæ…§åˆä½µç­–ç•¥ï¼šè‡ªå‹•åˆä½µè¼‰å…¥è¨˜éŒ„å’Œç•¶å‰æ¸¬é©—çµæœ
          let mergedCount = 0;
          let newCount = 0;
          
          Object.keys(loadedProgress).forEach(key => {
            if (key !== 'metadata') {
              const questionId = parseInt(key);
              if (!isNaN(questionId) && Array.isArray(loadedProgress[key])) {
                if (userProgress[questionId] && Array.isArray(userProgress[questionId])) {
                  // å¦‚æœç•¶å‰å·²æœ‰è©²é¡Œç›®çš„è¨˜éŒ„ï¼Œåˆä½µï¼šèˆŠè¨˜éŒ„åœ¨å‰ + ç•¶å‰çµæœåœ¨å¾Œ
                  const oldRecords = [...loadedProgress[key]];
                  const currentRecords = [...userProgress[questionId]];
                  userProgress[questionId] = [...oldRecords, ...currentRecords];
                  mergedCount++;
                } else {
                  // å¦‚æœç•¶å‰æ²’æœ‰è©²é¡Œç›®çš„è¨˜éŒ„ï¼Œç›´æ¥ä½¿ç”¨è¼‰å…¥çš„è¨˜éŒ„
                  userProgress[questionId] = [...loadedProgress[key]];
                  newCount++;
                }
              }
            }
          });
          
          // æ›´æ–° metadata
          if (!userProgress.metadata) {
            userProgress.metadata = {
              version: "1.0",
              lastUpdated: null,
              totalAttempted: 0
            };
          }
          userProgress.metadata.version = loadedProgress.metadata.version || "1.0";
          userProgress.metadata.lastUpdated = new Date().toISOString();
          userProgress.metadata.totalAttempted = Object.keys(userProgress).filter(key => key !== 'metadata').length;
          
          hasLoadedProgress = true;
          
          // è¨˜ä½æª”æ¡ˆåç¨±ï¼ˆç§»é™¤å‰¯æª”åå’Œå¯èƒ½çš„æ›´æ–°æ¨™è¨˜ï¼‰
          loadedFileName = file.name.replace(/\.json$/, '').replace(/_updated_[\d\-T]+$/, '');
          
          // å•Ÿç”¨æ­·å²è¨˜éŒ„ä¸‹è¼‰æŒ‰éˆ•
          updateHistoryButtonState();
          
          // é¡¯ç¤ºåˆä½µçµæœï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
          let statusMessage = `è¼‰å…¥æˆåŠŸï¼`;
          if (mergedCount > 0 || newCount > 0) {
            statusMessage += ` ç¸½è¨ˆ ${Object.keys(userProgress).length - 1} é¡Œè¨˜éŒ„`;
          }
          
          updateRecordStatus('success', statusMessage);
          
          // æ›´æ–°è¦–è¦ºåŒ–æŒ‰éˆ•ç‹€æ…‹
          setTimeout(() => {
            updateVisualizationButtonState();
          }, 100);
          
        } catch (error) {
          console.error("è¼‰å…¥æª”æ¡ˆéŒ¯èª¤:", error);
          updateRecordStatus('error', "æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
          // è¼‰å…¥å¤±æ•—æ™‚é‡ç½®ç‹€æ…‹
          loadedFileName = '';
          hasLoadedProgress = false;
          updateHistoryButtonState();
          
          // è¼‰å…¥å¤±æ•—æ™‚ä¹Ÿè¦æ›´æ–°è¦–è¦ºåŒ–æŒ‰éˆ•ç‹€æ…‹
          setTimeout(() => {
            updateVisualizationButtonState();
          }, 100);
        }
      };
      
      reader.readAsText(file);
    }

    // æ›´æ–°è¨˜éŒ„ç‹€æ…‹é¡¯ç¤º
    function updateRecordStatus(type, message) {
      const statusElement = document.getElementById('recordStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `record-status ${type}`;
      }
    }

    

    // è¨˜éŒ„ç•¶å‰æ¸¬é©—çµæœ
    function recordCurrentTest() {
      let recordedCount = 0;
      
      quiz.forEach((q, index) => {
        // åªè¨˜éŒ„å¯¦éš›ä½œç­”çš„é¡Œç›®
        if (!q.userAnswer) {
          return; // è·³éæœªä½œç­”çš„é¡Œç›®
        }
        
        // ç¢ºå®šç­”é¡Œçµæœ
        let result;
        const optionCount = Object.keys(q.options).length;
        const isBonusQuestion = optionCount === 5;
        
        if (isBonusQuestion) {
          result = 1; // é€åˆ†é¡Œï¼Œæœ‰ç­”å°±å°
        } else {
          result = isAnswerCorrect(q.userAnswer, q.answer) ? 1 : 0; // æ­£ç¢º=1, éŒ¯èª¤=0
        }
        
        // åˆå§‹åŒ–è©²é¡Œç›®çš„è¨˜éŒ„é™£åˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if (!userProgress[q.id]) {
          userProgress[q.id] = [];
        }
        
        // è¿½åŠ é€™æ¬¡çš„ç­”é¡Œçµæœåˆ°å·²å­˜åœ¨çš„è¨˜éŒ„é™£åˆ—
        userProgress[q.id].push(result);
        recordedCount++;
      });
      
      // æ›´æ–°å…ƒæ•¸æ“š
      if (!userProgress.metadata) {
        userProgress.metadata = {
          version: "1.0",
          lastUpdated: null,
          totalAttempted: 0
        };
      }
      userProgress.metadata.lastUpdated = new Date().toISOString();
      userProgress.metadata.totalAttempted = Object.keys(userProgress).filter(key => key !== 'metadata').length;
      
      // æ›´æ–°è¦–è¦ºåŒ–æŒ‰éˆ•ç‹€æ…‹
      setTimeout(() => {
        updateVisualizationButtonState();
      }, 100);
      
      console.log(`å·²è¨˜éŒ„ ${recordedCount} é¡Œçš„ç­”é¡Œçµæœ`);
    }

    // ä¸‹è¼‰ç›®å‰ä½œç­”è¨˜éŒ„
    function downloadCurrentProgress() {
      // åªä¸‹è¼‰ç•¶æ¬¡æ¸¬é©—çš„è¨˜éŒ„ï¼Œä¸åŒ…å«è¼‰å…¥çš„æ­·å²è¨˜éŒ„
      let currentTestProgress = {
        metadata: {
          version: "1.0",
          lastUpdated: new Date().toISOString(),
          totalAttempted: 0
        }
      };
      
      // æ”¶é›†ç•¶æ¬¡æ¸¬é©—çš„è¨˜éŒ„
      let currentTestCount = 0;
      quiz.forEach(q => {
        if (q.userAnswer) {
          // åªæ”¶é›†ç•¶æ¬¡ä½œç­”çš„é¡Œç›®
          const optionCount = Object.keys(q.options).length;
          const isBonusQuestion = optionCount === 5;
          let result;
          
          if (isBonusQuestion) {
            result = 1; // é€åˆ†é¡Œï¼Œæœ‰ç­”å°±å°
          } else {
            result = isAnswerCorrect(q.userAnswer, q.answer) ? 1 : 0; // æ­£ç¢º=1, éŒ¯èª¤=0
          }
          
          currentTestProgress[q.id] = [result];
          currentTestCount++;
        }
      });
      
      if (currentTestCount === 0) {
        updateRecordStatus('error', 'æ²’æœ‰ç›®å‰ä½œç­”è¨˜éŒ„');
        return;
      }
      
      currentTestProgress.metadata.totalAttempted = currentTestCount;
      
      const dataStr = JSON.stringify(currentTestProgress, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      link.download = `ç­”é¡Œè¨˜éŒ„_${timestamp}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      updateRecordStatus('success', `ç›®å‰è¨˜éŒ„å·²ä¸‹è¼‰`);
    }


    // æ­·å²è¨˜éŒ„ä¸‹è¼‰æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
    function updateHistoryButtonState() {
      const historyBtn = document.getElementById('historyRecordBtn');
      
      if (!historyBtn) return;
      
      if (!hasLoadedProgress || !loadedFileName) {
        // æœªè¼‰å…¥è¨˜éŒ„æª”ç‹€æ…‹
        historyBtn.disabled = true;
        historyBtn.style.backgroundColor = '#6c757d';
        historyBtn.style.cursor = 'not-allowed';
      } else {
        // å·²è¼‰å…¥è¨˜éŒ„æª”ç‹€æ…‹ - å¯é‡è¤‡ä½¿ç”¨
        historyBtn.disabled = false;
        historyBtn.style.backgroundColor = '#007bff';
        historyBtn.style.cursor = 'pointer';
      }
    }
    
    // ä¸‹è¼‰æ­·å²å®Œæ•´è¨˜éŒ„
    function downloadHistoryProgress() {
      if (!hasLoadedProgress || !loadedFileName) {
        updateRecordStatus('error', 'æ²’æœ‰æ­·å²è¨˜éŒ„æª”');
        return;
      }
      
      const recordCount = Object.keys(userProgress).filter(key => key !== 'metadata').length;
      
      if (recordCount === 0) {
        updateRecordStatus('error', 'æ²’æœ‰æ­·å²è¨˜éŒ„');
        return;
      }
      
      // ä¸‹è¼‰å®Œæ•´çš„ userProgressï¼ˆåŒ…å«è¼‰å…¥çš„æ­·å²è¨˜éŒ„ + ç•¶å‰æ¸¬é©—çµæœï¼‰
      const dataStr = JSON.stringify(userProgress, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
      link.download = `${loadedFileName}_updated_${timestamp}.json`;
      link.click();
      
      URL.revokeObjectURL(url);
      
      updateRecordStatus('success', `æ­·å²è¨˜éŒ„å·²ä¸‹è¼‰`);
    }

    // å–å¾—é¡Œç›®çš„æ­·å²è¨˜éŒ„
    function getQuestionHistory(questionId) {
      return userProgress[questionId] || [];
    }

    // è¨ˆç®—é¡Œç›®çš„æ­£ç¢ºç‡
    function calculateQuestionAccuracy(questionId) {
      const attempts = getQuestionHistory(questionId);
      if (attempts.length === 0) return null;
      
      const answeredAttempts = attempts.filter(result => result !== -1);
      if (answeredAttempts.length === 0) return null;
      
      const correctAttempts = answeredAttempts.filter(result => result === 1);
      return (correctAttempts.length / answeredAttempts.length) * 100;
    }

    // å®šç¾©å·²çŸ¥çš„å¹´ä»½å’Œç§‘ç›®æ¨™ç±¤
    const yearTags = ["114-2(ä¸€)", "114-1(ä¸€)", "113-2(ä¸€)", "113-1(ä¸€)", "112-2(ä¸€)", "112-1(ä¸€)", "111-2(ä¸€)", "111-1(ä¸€)", "110-2(ä¸€)", "110-1(ä¸€)", "109-2(ä¸€)", "109-1(ä¸€)", "108-2(ä¸€)", "108-1(ä¸€)", "107-2(ä¸€)", "107-1(ä¸€)", "106-2(ä¸€)", "106-1(ä¸€)", "105-2(ä¸€)", "105-1(ä¸€)", "104-2(ä¸€)", "104-1(ä¸€)", "114-2(äºŒ)", "114-1(äºŒ)", "113-2(äºŒ)", "113-1(äºŒ)", "112-2(äºŒ)", "112-1(äºŒ)", "111-2(äºŒ)", "111-1(äºŒ)", "110-2(äºŒ)", "110-1(äºŒ)", "109-2(äºŒ)", "109-1(äºŒ)", "108-2(äºŒ)", "108-1(äºŒ)", "107-2(äºŒ)", "107-1(äºŒ)", "106-2(äºŒ)", "106-1(äºŒ)", "105-2(äºŒ)", "105-1(äºŒ)", "104-2(äºŒ)", "104-1(äºŒ)"];
    const subjectTags = [
      // é†«å­¸(ä¸‰)å’Œé†«å­¸(å››)çš„ç§‘ç›®
      "å¿ƒè‡Ÿå…§ç§‘", "èƒ¸è…”å…§ç§‘", "è…¸èƒƒå…§ç§‘", "è‚è†½å…§ç§‘", "æ–°é™³ä»£è¬ç§‘", "è…è‡Ÿå…§ç§‘", "æ„ŸæŸ“ç§‘", "é¢¨æ¿•å…ç–«ç§‘", "è¡€æ¶²ç§‘", "è…«ç˜¤ç§‘", "å®¶é†«ç§‘", "å°å…’ç§‘", "çš®è†šç§‘", "ç²¾ç¥ç§‘", "ç¥ç¶“å…§ç§‘",
      // é†«å­¸(äº”)çš„ç§‘ç›®
      "å¤–ç§‘æ¦‚è«–", "ç¥ç¶“å¤–ç§‘", "å¿ƒè‡Ÿå¤–ç§‘", "å¤§è…¸ç›´è…¸å¤–ç§‘", "å…§åˆ†æ³Œå¤–ç§‘", "æ•´å½¢å¤–ç§‘", "èƒƒå¤–ç§‘", "å°è…¸å¤–ç§‘", "è‚è‡Ÿå¤–ç§‘", "è†½é“å¤–ç§‘", "èƒ°è‡Ÿå¤–ç§‘", "ä¹³æˆ¿å¤–ç§‘", "èƒ¸è…”å¤–ç§‘", "å°å…’å¤–ç§‘", "æ³Œå°¿å¤–ç§‘", "éª¨ç§‘",
      // é†«å­¸(å…­)çš„ç§‘ç›®
      "å©¦ç”¢ç§‘", "çœ¼ç§‘", "å¾©å¥ç§‘", "éº»é†‰ç§‘", "è€³é¼»å–‰ç§‘"
    ];

    // æ·»åŠ éµç›¤äº‹ä»¶ç›£è½å™¨
    document.addEventListener('keydown', function(event) {
      // åªåœ¨æ­¥é©Ÿæ¨¡å¼ä¸‹å•Ÿç”¨éµç›¤åŠŸèƒ½
      if (!isStepMode || !canUseSpacebar) return;
      
      if (event.code === 'Space' || event.key === ' ') {
        event.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
        
        // æª¢æŸ¥ç•¶å‰ç‹€æ…‹
        const submitBtn = document.getElementById(`submitAnswerBtn${currentQuestion}`);
        const nextBtn = document.getElementById('nextBtn');
        
        if (submitBtn && submitBtn.style.display !== 'none') {
          // å¦‚æœæäº¤ç­”æ¡ˆæŒ‰éˆ•å¯è¦‹ï¼ŒæŒ‰ç©ºç™½éµç­‰åŒæ–¼æäº¤ç­”æ¡ˆ
          checkStep(currentQuestion);
        } else if (nextBtn && nextBtn.style.display !== 'none') {
          // å¦‚æœä¸‹ä¸€é¡ŒæŒ‰éˆ•å¯è¦‹ï¼ŒæŒ‰ç©ºç™½éµç­‰åŒæ–¼ä¸‹ä¸€é¡Œ
          nextQuestion();
        }
      }
      
      // æ–°å¢ï¼šBackspace éµå›ä¸Šé¡Œ
      if (event.code === 'Backspace' || event.key === 'Backspace') {
        event.preventDefault(); // é˜²æ­¢ç€è¦½å™¨å¾Œé€€
        const prevBtn = document.getElementById('prevBtn');
        if (prevBtn && prevBtn.style.display !== 'none') {
          prevQuestion();
        }
      }
      
      // æ–¹å‘éµé¸æ“‡é¸é …ï¼ˆåªåœ¨å°šæœªæäº¤ç­”æ¡ˆæ™‚æœ‰æ•ˆï¼‰
      const submitBtn = document.getElementById(`submitAnswerBtn${currentQuestion}`);
      if (submitBtn && submitBtn.style.display !== 'none') {
        let optionToSelect = null;
        
        switch(event.code) {
          case 'ArrowUp':
            optionToSelect = 'A';
            break;
          case 'ArrowLeft':
            optionToSelect = 'B';
            break;
          case 'ArrowDown':
            optionToSelect = 'C';
            break;
          case 'ArrowRight':
            optionToSelect = 'D';
            break;
        }
        
        if (optionToSelect) {
          event.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•
          const radio = document.querySelector(`input[name='q${currentQuestion}'][value='${optionToSelect}']`);
          if (radio) {
            radio.checked = true;
          }
        }
      }
    });

    function selectQuestionsByGroup(questions, targetCount) {
      // æŒ‰ group_id åˆ†çµ„
      const groupMap = new Map();
      
      questions.forEach(q => {
        const groupId = q.group_id || `single_${q.question}`; // æ²’æœ‰ group_id çš„è¦–ç‚ºå–®ç¨ä¸€çµ„
        if (!groupMap.has(groupId)) {
          groupMap.set(groupId, []);
        }
        groupMap.get(groupId).push(q);
      });
      
      // å°‡åˆ†çµ„è½‰æ›ç‚ºé™£åˆ—ä¸¦éš¨æ©Ÿæ’åº
      const groups = Array.from(groupMap.values());
      const shuffledGroups = groups.sort(() => Math.random() - 0.5);
      
      // ä¾åºåŠ å…¥é¡Œç›®ç›´åˆ°é”åˆ°ç›®æ¨™æ•¸é‡
      let selectedQuestions = [];
      let currentCount = 0;
      
      for (const group of shuffledGroups) {
        if (currentCount + group.length <= targetCount) {
          // æ•´çµ„åŠ å…¥
          selectedQuestions = selectedQuestions.concat(group);
          currentCount += group.length;
        } else if (currentCount < targetCount) {
          // æª¢æŸ¥å‰©é¤˜ç©ºé–“æ˜¯å¦è¶³å¤ å®¹ç´å®Œæ•´çš„çµ„
          const remainingSpace = targetCount - currentCount;
          if (group.length <= remainingSpace) {
            selectedQuestions = selectedQuestions.concat(group);
            currentCount += group.length;
          }
          // å¦‚æœç•¶å‰çµ„ç„¡æ³•å®Œæ•´æ”¾å…¥ï¼Œå°±è·³éé€™çµ„
        }
        
        if (currentCount >= targetCount) {
          break;
        }
      }
      
      // å¦‚æœé‚„æ²’é”åˆ°ç›®æ¨™æ•¸é‡ï¼Œç§»é™¤æœ€å¾Œåªæœ‰1é¡Œçš„çµ„ç›´åˆ°ç¬¦åˆè¦æ±‚
      while (selectedQuestions.length > targetCount) {
        // æ‰¾å‡ºæœ€å¾Œé¢åªæœ‰1é¡Œçš„çµ„ä¸¦ç§»é™¤
        const groupCounts = new Map();
        selectedQuestions.forEach(q => {
          const groupId = q.group_id || `single_${q.question}`;
          groupCounts.set(groupId, (groupCounts.get(groupId) || 0) + 1);
        });
        
        let removedSingle = false;
        for (let i = selectedQuestions.length - 1; i >= 0; i--) {
          const q = selectedQuestions[i];
          const groupId = q.group_id || `single_${q.question}`;
          if (groupCounts.get(groupId) === 1) {
            selectedQuestions.splice(i, 1);
            removedSingle = true;
            break;
          }
        }
        
        if (!removedSingle) {
          // å¦‚æœæ²’æœ‰å–®é¡Œå¯ç§»é™¤ï¼Œå°±ç§»é™¤æœ€å¾Œä¸€çµ„
          const lastGroupId = selectedQuestions[selectedQuestions.length - 1].group_id || `single_${selectedQuestions[selectedQuestions.length - 1].question}`;
          selectedQuestions = selectedQuestions.filter(q => 
            (q.group_id || `single_${q.question}`) !== lastGroupId
          );
        }
      }
      
      return selectedQuestions;
    }

    function groupQuestionsByGroupId(questions, keepOriginalOrder = false) {
      // æŒ‰ group_id åˆ†çµ„
      const groupMap = new Map();
      
      questions.forEach(q => {
        const groupId = q.group_id || `single_${q.question}`;
        if (!groupMap.has(groupId)) {
          groupMap.set(groupId, []);
        }
        groupMap.get(groupId).push(q);
      });
      
      // å°‡å„çµ„é¡Œç›®é€£æ¥èµ·ä¾†ï¼Œç¢ºä¿åŒçµ„é¡Œç›®é€£çºŒ
      let result = [];
      const groups = Array.from(groupMap.values());
      
      let finalGroups;
      if (keepOriginalOrder) {
        // ä¿æŒåŸå§‹é †åºï¼šæŒ‰ç…§æ¯çµ„ç¬¬ä¸€å€‹é¡Œç›®åœ¨åŸå§‹questionsé™£åˆ—ä¸­çš„ä½ç½®æ’åº
        finalGroups = groups.sort((groupA, groupB) => {
          const firstQuestionA = groupA[0];
          const firstQuestionB = groupB[0];
          const indexA = questions.findIndex(q => q.question === firstQuestionA.question);
          const indexB = questions.findIndex(q => q.question === firstQuestionB.question);
          return indexA - indexB;
        });
      } else {
        // éš¨æ©Ÿæ’åˆ—å„çµ„çš„é †åº
        finalGroups = groups.sort(() => Math.random() - 0.5);
      }
      
      // å°‡å„çµ„ä¾åºåŠ å…¥ï¼Œä¿æŒçµ„å…§é¡Œç›®é€£çºŒ
      finalGroups.forEach(group => {
        result = result.concat(group);
      });
      
      return result;
    }
     
    function getSelectedValues(selectId) {
  let values = [];
  if (selectId === 'yearTag') {
    // å¾å››å€‹ medicine-block ä¸­åˆ†åˆ¥å–å¾—å¹´ä»½é¸æ“‡
    const allCheckboxes = document.querySelectorAll('.medicine-block .checkbox-group input[type="checkbox"]:checked');
    values = Array.from(allCheckboxes)
      .map(cb => cb.value)
      .filter(v => v !== 'all3' && v !== 'all4' && v !== 'all5' && v !== 'all6' && 
                   v !== 'medicine3-all' && v !== 'medicine4-all' && v !== 'medicine5-all' && v !== 'medicine6-all' && 
                   v.includes('-'));
  } else {
    const checkboxes = document.querySelectorAll(`#${selectId} input[type="checkbox"]:checked`);
    values = Array.from(checkboxes).map(cb => cb.value).filter(v => v !== 'all');
  }
  return values.length > 0 ? values : [];
}

    function handleSelectAll(type) {
  if (type === 'year3') {
    // æ‰¾åˆ°é†«å­¸(ä¸‰)å€å¡Šä¸­çš„å¹´ä»½å…¨é¸
    const medicine3Block = document.querySelectorAll('.medicine-block')[0]; // ç¬¬ä¸€å€‹ medicine-block
    const allCheckbox = medicine3Block.querySelector('input[value="all3"]');
    const otherCheckboxes = medicine3Block.querySelectorAll('.checkbox-group input[type="checkbox"]:not([value="all3"])');
    
    // åªé¸æ“‡å¹´ä»½ç›¸é—œçš„ checkboxï¼ˆæ’é™¤ç§‘ç›®ï¼‰
    const yearCheckboxes = Array.from(otherCheckboxes).filter(cb => cb.value.includes('-3'));
    
    if (allCheckbox.checked) {
      yearCheckboxes.forEach(cb => cb.checked = true);
    } else {
      yearCheckboxes.forEach(cb => cb.checked = false);
    }
  } else if (type === 'year4') {
    // æ‰¾åˆ°é†«å­¸(å››)å€å¡Šä¸­çš„å¹´ä»½å…¨é¸
    const medicine4Block = document.querySelectorAll('.medicine-block')[1]; // ç¬¬äºŒå€‹ medicine-block
    const allCheckbox = medicine4Block.querySelector('input[value="all4"]');
    const otherCheckboxes = medicine4Block.querySelectorAll('.checkbox-group input[type="checkbox"]:not([value="all4"])');
    
    // åªé¸æ“‡å¹´ä»½ç›¸é—œçš„ checkboxï¼ˆæ’é™¤ç§‘ç›®ï¼‰
    const yearCheckboxes = Array.from(otherCheckboxes).filter(cb => cb.value.includes('-4'));
    
    if (allCheckbox.checked) {
      yearCheckboxes.forEach(cb => cb.checked = true);
    } else {
      yearCheckboxes.forEach(cb => cb.checked = false);
    }
  } else if (type === 'medicine3-subject') {
    const medicine3Block = document.querySelectorAll('.medicine-block')[0];
    const allCheckbox = medicine3Block.querySelector('input[value="medicine3-all"]');
    const subjectCheckboxes = medicine3Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine3-all"])');
    const allSubjectsCount = document.getElementById('count-medicine3-all-subjects');
    
    if (allCheckbox.checked) {
      subjectCheckboxes.forEach(cb => {
        cb.checked = true;
        const countDiv = document.getElementById(`count-medicine3-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'block';
    } else {
      subjectCheckboxes.forEach(cb => {
        cb.checked = false;
        const countDiv = document.getElementById(`count-medicine3-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'none';
    }
  } else if (type === 'medicine4-subject') {
    const medicine4Block = document.querySelectorAll('.medicine-block')[1];
    const allCheckbox = medicine4Block.querySelector('input[value="medicine4-all"]');
    const subjectCheckboxes = medicine4Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine4-all"])');
    const allSubjectsCount = document.getElementById('count-medicine4-all-subjects');
    
    if (allCheckbox.checked) {
      subjectCheckboxes.forEach(cb => {
        cb.checked = true;
        const countDiv = document.getElementById(`count-medicine4-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'block';
    } else {
      subjectCheckboxes.forEach(cb => {
        cb.checked = false;
        const countDiv = document.getElementById(`count-medicine4-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'none';
    }
  } else if (type === 'year5') {
    // æ‰¾åˆ°é†«å­¸(äº”)å€å¡Šä¸­çš„å¹´ä»½å…¨é¸
    const medicine5Block = document.querySelectorAll('.medicine-block')[2]; // ç¬¬ä¸‰å€‹ medicine-block
    const allCheckbox = medicine5Block.querySelector('input[value="all5"]');
    const otherCheckboxes = medicine5Block.querySelectorAll('.checkbox-group input[type="checkbox"]:not([value="all5"])');
    
    // åªé¸æ“‡å¹´ä»½ç›¸é—œçš„ checkboxï¼ˆæ’é™¤ç§‘ç›®ï¼‰
    const yearCheckboxes = Array.from(otherCheckboxes).filter(cb => cb.value.includes('-5'));
    
    if (allCheckbox.checked) {
      yearCheckboxes.forEach(cb => cb.checked = true);
    } else {
      yearCheckboxes.forEach(cb => cb.checked = false);
    }
  } else if (type === 'year6') {
    // æ‰¾åˆ°é†«å­¸(å…­)å€å¡Šä¸­çš„å¹´ä»½å…¨é¸
    const medicine6Block = document.querySelectorAll('.medicine-block')[3]; // ç¬¬å››å€‹ medicine-block
    const allCheckbox = medicine6Block.querySelector('input[value="all6"]');
    const otherCheckboxes = medicine6Block.querySelectorAll('.checkbox-group input[type="checkbox"]:not([value="all6"])');
    
    // åªé¸æ“‡å¹´ä»½ç›¸é—œçš„ checkboxï¼ˆæ’é™¤ç§‘ç›®ï¼‰
    const yearCheckboxes = Array.from(otherCheckboxes).filter(cb => cb.value.includes('-6'));
    
    if (allCheckbox.checked) {
      yearCheckboxes.forEach(cb => cb.checked = true);
    } else {
      yearCheckboxes.forEach(cb => cb.checked = false);
    }
  } else if (type === 'medicine5-subject') {
    const medicine5Block = document.querySelectorAll('.medicine-block')[2];
    const allCheckbox = medicine5Block.querySelector('input[value="medicine5-all"]');
    const subjectCheckboxes = medicine5Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine5-all"])');
    const allSubjectsCount = document.getElementById('count-medicine5-all-subjects');
    
    if (allCheckbox.checked) {
      subjectCheckboxes.forEach(cb => {
        cb.checked = true;
        const countDiv = document.getElementById(`count-medicine5-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'block';
    } else {
      subjectCheckboxes.forEach(cb => {
        cb.checked = false;
        const countDiv = document.getElementById(`count-medicine5-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'none';
    }
  } else if (type === 'medicine6-subject') {
    const medicine6Block = document.querySelectorAll('.medicine-block')[3];
    const allCheckbox = medicine6Block.querySelector('input[value="medicine6-all"]');
    const subjectCheckboxes = medicine6Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine6-all"])');
    const allSubjectsCount = document.getElementById('count-medicine6-all-subjects');
    
    if (allCheckbox.checked) {
      subjectCheckboxes.forEach(cb => {
        cb.checked = true;
        const countDiv = document.getElementById(`count-medicine6-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'block';
    } else {
      subjectCheckboxes.forEach(cb => {
        cb.checked = false;
        const countDiv = document.getElementById(`count-medicine6-${cb.value}`);
        if (countDiv) {
          countDiv.style.display = 'none';
        }
      });
      allSubjectsCount.style.display = 'none';
    }
  }
}

    function toggleSubjectCount(checkbox, medicineType) {
      const subject = checkbox.value;
      const countDiv = document.getElementById(`count-${medicineType}-${subject}`);
      const allCheckbox = document.querySelector(`#${medicineType}-subjects input[value="${medicineType}-all"]`);
      const allSubjectsCount = document.getElementById(`count-${medicineType}-all-subjects`);
      
      if (checkbox.checked) {
        // å¦‚æœä¸æ˜¯å…¨é¸ç‹€æ…‹ï¼Œé¡¯ç¤ºå€‹åˆ¥é¡Œæ•¸è¼¸å…¥æ¡†
        if (!allCheckbox.checked) {
          countDiv.style.display = 'block';
        }
      } else {
        countDiv.style.display = 'none';
        // å–æ¶ˆå…¨é¸ç‹€æ…‹
        allCheckbox.checked = false;
        allSubjectsCount.style.display = 'none';
      }
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å…¨é¸ç‹€æ…‹
      updateAllSelectStatus(medicineType + '-subject');
    }

    function selectMockExam(checkbox, type) {
 if (checkbox.checked) {
   if (type === 'ä¸€') {
     // é¸æ“‡é†«å¸«(ä¸€)ç§‘ç›®ä¸¦è¨­å®šé¡Œæ•¸
     const subjects = [
       {name: 'è§£å‰–', count: 31},
       {name: 'èƒšèƒ', count: 5},
       {name: 'çµ„ç¹”', count: 10},
       {name: 'ç”Ÿç†', count: 27},
       {name: 'ç”ŸåŒ–', count: 27}
     ];
     subjects.forEach(subject => {
       const subjectCheckbox = document.querySelector(`input[value="${subject.name}"]`);
       const countInput = document.querySelector(`#count-${subject.name} input`);
       if (subjectCheckbox) {
         subjectCheckbox.checked = true;
         document.getElementById(`count-${subject.name}`).style.display = 'block';
         if (countInput) countInput.value = subject.count;
       }
     });
   } else if (type === 'äºŒ') {
     // é¸æ“‡é†«å¸«(äºŒ)ç§‘ç›®ä¸¦è¨­å®šé¡Œæ•¸
     const subjects = [
       {name: 'å¾®ç”Ÿç‰©', count: 17},
       {name: 'å…ç–«', count: 11},
       {name: 'å¯„ç”ŸèŸ²', count: 7},
       {name: 'å…¬è¡›', count: 15},
       {name: 'è—¥ç†', count: 25},
       {name: 'ç—…ç†', count: 25}
     ];
     subjects.forEach(subject => {
       const subjectCheckbox = document.querySelector(`input[value="${subject.name}"]`);
       const countInput = document.querySelector(`#count-${subject.name} input`);
       if (subjectCheckbox) {
         subjectCheckbox.checked = true;
         document.getElementById(`count-${subject.name}`).style.display = 'block';
         if (countInput) countInput.value = subject.count;
       }
     });
   }
 }
 // ç§»é™¤äº† else å€å¡Šä¸­çš„å–æ¶ˆå‹¾é¸é‚è¼¯
}

    function updateAllSelectStatus(type) {
      if (type === 'medicine3-subject') {
        const medicine3Block = document.querySelectorAll('.medicine-block')[0];
        const allCheckbox = medicine3Block.querySelector('input[value="medicine3-all"]');
        const otherCheckboxes = medicine3Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine3-all"])');
        const checkedCount = Array.from(otherCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount === otherCheckboxes.length && checkedCount > 0) {
          // ä¸è‡ªå‹•åˆ‡æ›åˆ°å…¨é¸æ¨¡å¼ï¼Œä¿æŒå€‹åˆ¥è¨­å®šæ¨¡å¼
        } else if (checkedCount === 0) {
          allCheckbox.checked = false;
          document.getElementById('count-medicine3-all-subjects').style.display = 'none';
        }
      } else if (type === 'medicine4-subject') {
        const medicine4Block = document.querySelectorAll('.medicine-block')[1];
        const allCheckbox = medicine4Block.querySelector('input[value="medicine4-all"]');
        const otherCheckboxes = medicine4Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine4-all"])');
        const checkedCount = Array.from(otherCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount === otherCheckboxes.length && checkedCount > 0) {
          // ä¸è‡ªå‹•åˆ‡æ›åˆ°å…¨é¸æ¨¡å¼ï¼Œä¿æŒå€‹åˆ¥è¨­å®šæ¨¡å¼
        } else if (checkedCount === 0) {
          allCheckbox.checked = false;
          document.getElementById('count-medicine4-all-subjects').style.display = 'none';
        }
      } else if (type === 'medicine5-subject') {
        const medicine5Block = document.querySelectorAll('.medicine-block')[2];
        const allCheckbox = medicine5Block.querySelector('input[value="medicine5-all"]');
        const otherCheckboxes = medicine5Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine5-all"])');
        const checkedCount = Array.from(otherCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount === otherCheckboxes.length && checkedCount > 0) {
          // ä¸è‡ªå‹•åˆ‡æ›åˆ°å…¨é¸æ¨¡å¼ï¼Œä¿æŒå€‹åˆ¥è¨­å®šæ¨¡å¼
        } else if (checkedCount === 0) {
          allCheckbox.checked = false;
          document.getElementById('count-medicine5-all-subjects').style.display = 'none';
        }
      } else if (type === 'medicine6-subject') {
        const medicine6Block = document.querySelectorAll('.medicine-block')[3];
        const allCheckbox = medicine6Block.querySelector('input[value="medicine6-all"]');
        const otherCheckboxes = medicine6Block.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:not([value="medicine6-all"])');
        const checkedCount = Array.from(otherCheckboxes).filter(cb => cb.checked).length;
        
        if (checkedCount === otherCheckboxes.length && checkedCount > 0) {
          // ä¸è‡ªå‹•åˆ‡æ›åˆ°å…¨é¸æ¨¡å¼ï¼Œä¿æŒå€‹åˆ¥è¨­å®šæ¨¡å¼
        } else if (checkedCount === 0) {
          allCheckbox.checked = false;
          document.getElementById('count-medicine6-all-subjects').style.display = 'none';
        }
      } else {
        const groupId = 'yearTag';
        const allCheckbox = document.querySelector(`#${groupId} input[value="all"]`);
        const otherCheckboxes = document.querySelectorAll(`#${groupId} input[type="checkbox"]:not([value="all"])`);
        const checkedCount = Array.from(otherCheckboxes).filter(cb => cb.checked).length;
        
        allCheckbox.checked = checkedCount === otherCheckboxes.length;
      }
    }

    function formatTags(tags) {
      return tags.map(tag => {
        const isYear = yearTags.includes(tag);
        const tagClass = isYear ? 'tag year' : 'tag subject';
        return `<span class="${tagClass}">${tag}</span>`;
      }).join(' ');
    }

    async function startQuiz() {
  // éš±è—é¦–é è¨˜éŒ„å€åŸŸ
  const homepageSection = document.getElementById('homepageRecordSection');
  if (homepageSection) {
    homepageSection.style.display = 'none';
  }
  
  const selectedYears = getSelectedValues('yearTag');
  
  // åˆ†åˆ¥ç²å–é†«å­¸(ä¸‰)å’Œé†«å­¸(å››)çš„ç§‘ç›®é¸æ“‡
  const medicine3Subjects = getSelectedSubjects('medicine3');
  const medicine4Subjects = getSelectedSubjects('medicine4');
  const medicine5Subjects = getSelectedSubjects('medicine5');
  const medicine6Subjects = getSelectedSubjects('medicine6');
  
  if (selectedYears.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å¹´ä»½');
    return;
  }
  
  if (medicine3Subjects.subjects.length === 0 && medicine4Subjects.subjects.length === 0 && 
      medicine5Subjects.subjects.length === 0 && medicine6Subjects.subjects.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç§‘ç›®');
    return;
  }

  // å¾å¤–éƒ¨æª”æ¡ˆè¼‰å…¥é¡Œç›®
  let allLoadedQuestions = [];

  console.log('=== é–‹å§‹è¼‰å…¥é¡Œç›® ===');
  console.log('é¸æ“‡çš„å¹´ä»½ï¼š', selectedYears);

  for (const yearValue of selectedYears) {
    const filename = `./exam/${yearValue}.json`;
    
    console.log(`å˜—è©¦è¼‰å…¥æª”æ¡ˆï¼š${filename}`);
    
    try {
      const response = await fetch(filename);
      
      console.log(`${filename} - å›æ‡‰ç‹€æ…‹ï¼š${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        console.error(`âŒ ç„¡æ³•è¼‰å…¥æª”æ¡ˆï¼š${filename} (HTTP ${response.status})`);
        continue;
      }
      
      const text = await response.text();
      console.log(`âœ“ ${filename} è¼‰å…¥æˆåŠŸï¼Œé•·åº¦ï¼š${text.length} å­—å…ƒ`);
      
      const questionsData = JSON.parse(text);
      console.log(`âœ“ ${filename} è§£ææˆåŠŸï¼Œé¡Œæ•¸ï¼š${questionsData.length} é¡Œ`);
      
      // ç‚ºæ¯é¡Œæ·»åŠ å¹´ä»½æ¨™ç±¤
      const yearMatch = yearValue.match(/(\d{3}-\d)/);
      const yearLabel = yearMatch ? yearMatch[1] : yearValue;
      questionsData.forEach(q => {
        if (!q.tags) q.tags = [];
        q.tags.push(yearLabel);
      });
      
      allLoadedQuestions.push(...questionsData);
    } catch (error) {
      console.error(`âŒ è¼‰å…¥ ${filename} æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š`, error);
    }
  }

  console.log(`=== è¼‰å…¥å®Œæˆï¼Œç¸½å…± ${allLoadedQuestions.length} é¡Œ ===`);

  if (allLoadedQuestions.length === 0) {
    alert('ç„¡æ³•è¼‰å…¥é¡Œç›®ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨');
    return;
  }

  // è™•ç†é¡Œç›®ç¯©é¸
  let finalQuiz = [];
  let insufficientSubjects = [];
  
  // è™•ç†é†«å­¸(ä¸‰)
  if (medicine3Subjects.subjects.length > 0) {
    if (medicine3Subjects.isAllSelected) {
      const totalCount = medicine3Subjects.totalCount;
      const filteredQuestions = allLoadedQuestions.filter(q => 
        medicine3Subjects.subjects.some(subject => q.subject === subject || q.tags.includes(subject))
      );
      
      if (filteredQuestions.length < totalCount) {
        const confirmUseAll = await customConfirm(`é†«å­¸(ä¸‰) é¡Œåº«æ•¸é‡ä¸è¶³ï¼<br><br>æ‚¨è¦æ±‚çš„é¡Œæ•¸ï¼š${totalCount} é¡Œ<br>å¯¦éš›é¡Œåº«æ•¸é‡ï¼š${filteredQuestions.length} é¡Œ<br><br>æ˜¯å¦ä½¿ç”¨æ‰€æœ‰ ${filteredQuestions.length} é¡Œé€²è¡Œæ¸¬é©—ï¼Ÿ`);
        if (!confirmUseAll) return;
        finalQuiz = finalQuiz.concat(filteredQuestions);
      } else {
        const shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, totalCount));
      }
    } else {
      // å€‹åˆ¥ç§‘ç›®æ¨¡å¼
      for (const subjectInfo of medicine3Subjects.subjectCounts) {
        const subjectQuestions = allLoadedQuestions.filter(q => 
          q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
        );
        
        if (subjectQuestions.length === 0) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š0 é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        } else if (subjectQuestions.length < subjectInfo.count) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š${subjectQuestions.length} é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        }
      }
    }
  }
  
  // è™•ç†é†«å­¸(å››)
  if (medicine4Subjects.subjects.length > 0) {
    if (medicine4Subjects.isAllSelected) {
      const totalCount = medicine4Subjects.totalCount;
      const filteredQuestions = allLoadedQuestions.filter(q => 
        medicine4Subjects.subjects.some(subject => q.subject === subject || q.tags.includes(subject))
      );
      
      if (filteredQuestions.length < totalCount) {
        const confirmUseAll = await customConfirm(`é†«å­¸(å››) é¡Œåº«æ•¸é‡ä¸è¶³ï¼<br><br>æ‚¨è¦æ±‚çš„é¡Œæ•¸ï¼š${totalCount} é¡Œ<br>å¯¦éš›é¡Œåº«æ•¸é‡ï¼š${filteredQuestions.length} é¡Œ<br><br>æ˜¯å¦ä½¿ç”¨æ‰€æœ‰ ${filteredQuestions.length} é¡Œé€²è¡Œæ¸¬é©—ï¼Ÿ`);
        if (!confirmUseAll) return;
        finalQuiz = finalQuiz.concat(filteredQuestions);
      } else {
        const shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, totalCount));
      }
    } else {
      // å€‹åˆ¥ç§‘ç›®æ¨¡å¼
      for (const subjectInfo of medicine4Subjects.subjectCounts) {
        const subjectQuestions = allLoadedQuestions.filter(q => 
          q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
        );
        
        if (subjectQuestions.length === 0) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š0 é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        } else if (subjectQuestions.length < subjectInfo.count) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š${subjectQuestions.length} é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        }
      }
    }
  }
  
  // è™•ç†é†«å­¸(äº”)
  if (medicine5Subjects.subjects.length > 0) {
    if (medicine5Subjects.isAllSelected) {
      const totalCount = medicine5Subjects.totalCount;
      const filteredQuestions = allLoadedQuestions.filter(q => 
        medicine5Subjects.subjects.some(subject => q.subject === subject || q.tags.includes(subject))
      );
      
      if (filteredQuestions.length < totalCount) {
        const confirmUseAll = await customConfirm(`é†«å­¸(äº”) é¡Œåº«æ•¸é‡ä¸è¶³ï¼<br><br>æ‚¨è¦æ±‚çš„é¡Œæ•¸ï¼š${totalCount} é¡Œ<br>å¯¦éš›é¡Œåº«æ•¸é‡ï¼š${filteredQuestions.length} é¡Œ<br><br>æ˜¯å¦ä½¿ç”¨æ‰€æœ‰ ${filteredQuestions.length} é¡Œé€²è¡Œæ¸¬é©—ï¼Ÿ`);
        if (!confirmUseAll) return;
        finalQuiz = finalQuiz.concat(filteredQuestions);
      } else {
        const shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, totalCount));
      }
    } else {
      // å€‹åˆ¥ç§‘ç›®æ¨¡å¼
      for (const subjectInfo of medicine5Subjects.subjectCounts) {
        const subjectQuestions = allLoadedQuestions.filter(q => 
          q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
        );
        
        if (subjectQuestions.length === 0) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š0 é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        } else if (subjectQuestions.length < subjectInfo.count) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š${subjectQuestions.length} é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        }
      }
    }
  }
  
  // è™•ç†é†«å­¸(å…­)
  if (medicine6Subjects.subjects.length > 0) {
    if (medicine6Subjects.isAllSelected) {
      const totalCount = medicine6Subjects.totalCount;
      const filteredQuestions = allLoadedQuestions.filter(q => 
        medicine6Subjects.subjects.some(subject => q.subject === subject || q.tags.includes(subject))
      );
      
      if (filteredQuestions.length < totalCount) {
        const confirmUseAll = await customConfirm(`é†«å­¸(å…­) é¡Œåº«æ•¸é‡ä¸è¶³ï¼<br><br>æ‚¨è¦æ±‚çš„é¡Œæ•¸ï¼š${totalCount} é¡Œ<br>å¯¦éš›é¡Œåº«æ•¸é‡ï¼š${filteredQuestions.length} é¡Œ<br><br>æ˜¯å¦ä½¿ç”¨æ‰€æœ‰ ${filteredQuestions.length} é¡Œé€²è¡Œæ¸¬é©—ï¼Ÿ`);
        if (!confirmUseAll) return;
        finalQuiz = finalQuiz.concat(filteredQuestions);
      } else {
        const shuffled = [...filteredQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, totalCount));
      }
    } else {
      // å€‹åˆ¥ç§‘ç›®æ¨¡å¼
      for (const subjectInfo of medicine6Subjects.subjectCounts) {
        const subjectQuestions = allLoadedQuestions.filter(q => 
          q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
        );
        
        if (subjectQuestions.length === 0) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š0 é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        } else if (subjectQuestions.length < subjectInfo.count) {
          insufficientSubjects.push(`${subjectInfo.subject}ï¼š${subjectQuestions.length} é¡Œï¼ˆè¦æ±‚ ${subjectInfo.count} é¡Œï¼‰`);
        }
      }
    }
  }
  
  // å¦‚æœæœ‰é¡Œåº«ä¸è¶³çš„ç§‘ç›®ï¼Œé¡¯ç¤ºæé†’
  if (insufficientSubjects.length > 0) {
    const confirmMessage = `ä»¥ä¸‹ç§‘ç›®é¡Œåº«æ•¸é‡ä¸è¶³ï¼š<br><br>${insufficientSubjects.join('<br>')}<br><br>æ˜¯å¦ä½¿ç”¨ç¾æœ‰é¡Œç›®é€²è¡Œæ¸¬é©—ï¼Ÿ`;
    const confirmUseAvailable = await customConfirm(confirmMessage);
    if (!confirmUseAvailable) return;
  }
  
  // å¯¦éš›é¸å–é¡Œç›®ï¼ˆå€‹åˆ¥ç§‘ç›®æ¨¡å¼ï¼‰
  if (!medicine3Subjects.isAllSelected) {
    for (const subjectInfo of medicine3Subjects.subjectCounts) {
      const subjectQuestions = allLoadedQuestions.filter(q => 
        q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
      );
      
      if (subjectQuestions.length === 0) continue;
      
      if (subjectQuestions.length <= subjectInfo.count) {
        finalQuiz = finalQuiz.concat(subjectQuestions);
      } else {
        const shuffled = [...subjectQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, subjectInfo.count));
      }
    }
  }
  
  if (!medicine4Subjects.isAllSelected) {
    for (const subjectInfo of medicine4Subjects.subjectCounts) {
      const subjectQuestions = allLoadedQuestions.filter(q => 
        q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
      );
      
      if (subjectQuestions.length === 0) continue;
      
      if (subjectQuestions.length <= subjectInfo.count) {
        finalQuiz = finalQuiz.concat(subjectQuestions);
      } else {
        const shuffled = [...subjectQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, subjectInfo.count));
      }
    }
  }
  
  if (!medicine5Subjects.isAllSelected) {
    for (const subjectInfo of medicine5Subjects.subjectCounts) {
      const subjectQuestions = allLoadedQuestions.filter(q => 
        q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
      );
      
      if (subjectQuestions.length === 0) continue;
      
      if (subjectQuestions.length <= subjectInfo.count) {
        finalQuiz = finalQuiz.concat(subjectQuestions);
      } else {
        const shuffled = [...subjectQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, subjectInfo.count));
      }
    }
  }
  
  if (!medicine6Subjects.isAllSelected) {
    for (const subjectInfo of medicine6Subjects.subjectCounts) {
      const subjectQuestions = allLoadedQuestions.filter(q => 
        q.subject === subjectInfo.subject || q.tags.includes(subjectInfo.subject)
      );
      
      if (subjectQuestions.length === 0) continue;
      
      if (subjectQuestions.length <= subjectInfo.count) {
        finalQuiz = finalQuiz.concat(subjectQuestions);
      } else {
        const shuffled = [...subjectQuestions].sort(() => Math.random() - 0.5);
        finalQuiz = finalQuiz.concat(shuffled.slice(0, subjectInfo.count));
      }
    }
  }

  if (finalQuiz.length === 0) {
    alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®ï¼Œè«‹é‡æ–°é¸æ“‡å¹´ä»½æˆ–ç§‘ç›®');
    return;
  }

  // æ ¹æ“šé¸æ“‡çš„å‡ºé¡Œé †åºä¾†æ±ºå®šæ˜¯å¦éš¨æ©Ÿæ’åº
  const questionOrder = document.getElementById('questionOrder').value;
  
  if (questionOrder === 'random') {
    quiz = [...finalQuiz].sort(() => Math.random() - 0.5);
  } else {
    // æŒ‰ç…§ id æ’åº
    quiz = [...finalQuiz].sort((a, b) => a.id - b.id);
  }
  
  currentQuestion = 0;
  correct = 0;

  const mode = document.getElementById('mode').value;
  isStepMode = mode === 'step';
  const isBrowseMode = mode === 'browse';
  
  document.getElementById('result').innerText = '';
  document.getElementById('quiz').innerHTML = '';

  // éš±è—è¨­å®šå€åŸŸå’Œæ¨™é¡Œå€åŸŸ
  document.getElementById('setupSection').classList.add('hidden');
  document.getElementById('headerSection').classList.add('hidden');

  if (isBrowseMode) {
    showBrowseResults();
    return;
  } else if (isStepMode) {
    document.getElementById('progressInfo').classList.remove('hidden');
    document.getElementById('stepControls').classList.remove('hidden');
    document.getElementById('submitBtn').classList.add('hidden');
    document.getElementById('totalQuestions').innerText = quiz.length;
    canUseSpacebar = true;
    showQuestion(currentQuestion);
  } else {
    document.getElementById('progressInfo').classList.add('hidden');
    document.getElementById('stepControls').classList.add('hidden');
    document.getElementById('submitBtn').classList.remove('hidden');
    canUseSpacebar = false;
    showAllQuestions();
  }
}

    // ç²å–é¸æ“‡çš„ç§‘ç›®è³‡è¨Šï¼ˆåŒ…å«æ˜¯å¦å…¨é¸å’Œé¡Œæ•¸ï¼‰
    function getSelectedSubjects(medicineType) {
      let allCheckbox, otherCheckboxes, medicineBlock;
      
      if (medicineType === 'medicine3') {
        medicineBlock = document.querySelectorAll('.medicine-block')[0];
        allCheckbox = medicineBlock.querySelector('input[value="medicine3-all"]');
        otherCheckboxes = medicineBlock.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:checked:not([value="medicine3-all"])');
      } else if (medicineType === 'medicine4') {
        medicineBlock = document.querySelectorAll('.medicine-block')[1];
        allCheckbox = medicineBlock.querySelector('input[value="medicine4-all"]');
        otherCheckboxes = medicineBlock.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:checked:not([value="medicine4-all"])');
      } else if (medicineType === 'medicine5') {
        medicineBlock = document.querySelectorAll('.medicine-block')[2];
        allCheckbox = medicineBlock.querySelector('input[value="medicine5-all"]');
        otherCheckboxes = medicineBlock.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:checked:not([value="medicine5-all"])');
      } else if (medicineType === 'medicine6') {
        medicineBlock = document.querySelectorAll('.medicine-block')[3];
        allCheckbox = medicineBlock.querySelector('input[value="medicine6-all"]');
        otherCheckboxes = medicineBlock.querySelectorAll('.checkbox-group:last-child input[type="checkbox"]:checked:not([value="medicine6-all"])');
      }
      
      const isAllSelected = allCheckbox ? allCheckbox.checked : false;
      const subjects = Array.from(otherCheckboxes).map(cb => cb.value);
      let totalCount = 80;
      let subjectCounts = [];
      
      if (isAllSelected) {
        const totalCountInput = document.querySelector(`#count-${medicineType}-all-subjects input`);
        totalCount = parseInt(totalCountInput.value) || 80;
      } else {
        subjectCounts = subjects.map(subject => {
          const countInput = document.querySelector(`#count-${medicineType}-${subject} input`);
          return {
            subject: subject,
            count: parseInt(countInput.value) || 1
          };
        });
      }
      
      return {
        subjects: subjects,
        isAllSelected: isAllSelected,
        totalCount: totalCount,
        subjectCounts: subjectCounts
      };
    }

    function showQuestion(i) {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = '';
      const q = quiz[i];
      
      // é‡ç½®è­¦å‘Šç‹€æ…‹ï¼ˆæ¯é¡Œé–‹å§‹æ™‚é‡ç½®ï¼‰
      hasWarned = false;
      
      // æ›´æ–°é€²åº¦é¡¯ç¤º
      document.getElementById('currentQuestionNum').innerText = i + 1;
      
      const qBlock = document.createElement('div');
      qBlock.className = 'question-block';
      
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“å›ç­”éé€™é¡Œ
      const isAnswered = q.userAnswer !== undefined;
      
      qBlock.innerHTML = `
        <h3>ç¬¬ ${i + 1} é¡Œ</h3>
        <p>${q.question}</p>
        ${q.images ? generateImageHTML(q.images) : ''}
        ${Object.entries(q.options).map(([key, value]) => `<label><input type="radio" name="q${i}" value="${key}" ${isAnswered && q.userAnswer === key ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}> ${key}. ${value}</label><br>`).join('')}
        <div class="warning-message" id="warning${i}">âš ï¸ è«‹å…ˆé¸æ“‡ä¸€å€‹é¸é …å†æäº¤ç­”æ¡ˆï¼</div>
        <div class="explanation" id="explanation${i}">${q.explanation}</div>
        <button id="submitAnswerBtn${i}" class="submit-answer-btn" onclick="checkStep(${i})" ${isAnswered ? 'style="display:none"' : ''}>æäº¤ç­”æ¡ˆ</button>
      `;
      quizDiv.appendChild(qBlock);
      
      // å¦‚æœå·²ç¶“å›ç­”éï¼Œé¡¯ç¤ºè©³è§£
      if (isAnswered) {
        const explanation = document.getElementById(`explanation${i}`);
        explanation.dataset.answered = "true";
        
        // é‡æ–°ç”Ÿæˆè©³è§£å…§å®¹
        const optionCount = Object.keys(q.options).length;
        const isBonusQuestion = optionCount === 5;
        
        // æ¸…é™¤ä¹‹å‰çš„æ¨£å¼é¡åˆ¥
        explanation.classList.remove('correct', 'incorrect');
        
        let explanationText = '';
        if (isBonusQuestion && q.userAnswer) {
          explanation.classList.add('correct');
          explanationText = `<span class="result-correct">âœ“ æ­£ç¢ºï¼ï¼ˆé€åˆ†é¡Œï¼‰</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>ä½ çš„ç­”æ¡ˆï¼š${q.userAnswer}. ${q.options[q.userAnswer]}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
        } else if (q.userAnswer && isAnswerCorrect(q.userAnswer, q.answer)) {
          explanation.classList.add('correct');
          explanationText = `<span class="result-correct">âœ“ æ­£ç¢ºï¼</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
        } else {
          explanation.classList.add('incorrect');
          explanationText = `<span class="result-incorrect">âœ— éŒ¯èª¤ï¼</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>ä½ çš„ç­”æ¡ˆï¼š<br>${formatUserAnswer(q.userAnswer, q.options)}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
        }
        explanation.innerHTML = explanationText.replace(/\n/g, '<br>');
        explanation.style.display = 'block';
        
        // é‡ç½®è­¦å‘Šç‹€æ…‹ï¼Œå› ç‚ºå·²ç¶“æ˜¯å›ç­”éçš„é¡Œç›®
        hasWarned = false;
      }
      
      // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
      updateButtonDisplay();
    }

    function checkStep(i) {
      const chosen = document.querySelector(`input[name='q${i}']:checked`);
      const explanation = document.getElementById(`explanation${i}`);
      const submitBtn = document.getElementById(`submitAnswerBtn${i}`);
      const warningMsg = document.getElementById(`warning${i}`);
      
      // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡é¸é …
      if (!chosen) {
        if (!hasWarned) {
          // ç¬¬ä¸€æ¬¡è­¦å‘Šï¼Œé¡¯ç¤ºè­¦å‘Šè¨Šæ¯
          warningMsg.style.display = 'block';
          hasWarned = true;
          return;
        }
        // ç¬¬äºŒæ¬¡æäº¤ï¼Œéš±è—è­¦å‘Šè¨Šæ¯ä¸¦å…è¨±ç¹¼çºŒï¼ˆè¦–ç‚ºæœªä½œç­”ï¼‰
        warningMsg.style.display = 'none';
      }
      
      // é–å®šæ‰€æœ‰é¸é …ï¼Œé˜²æ­¢ä¿®æ”¹ç­”æ¡ˆ
      const allOptions = document.querySelectorAll(`input[name='q${i}']`);
      allOptions.forEach(option => {
        option.disabled = true;
      });
      
      if (!explanation.dataset.answered) {
        explanation.dataset.answered = "true";
        quiz[i].userAnswer = chosen ? chosen.value : null;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºäº”å€‹é¸é …çš„é¡Œç›®ï¼ˆé€åˆ†é¡Œï¼‰
        const optionCount = Object.keys(quiz[i].options).length;
        const isBonusQuestion = optionCount === 5;
        
        let explanationText = '';
        if (isBonusQuestion && chosen) {
          // äº”å€‹é¸é …çš„é¡Œç›®ï¼Œæœ‰é¸å°±å°
          explanation.classList.add('correct');
          correct++;
          quiz[i].isCorrect = true;
          explanationText = `<span class="result-correct">âœ“ æ­£ç¢ºï¼ï¼ˆé€åˆ†é¡Œï¼‰</span><br>æ¨™ç±¤ï¼š${formatTags(quiz[i].tags)}<br>ä½ çš„ç­”æ¡ˆï¼š${chosen.value}. ${quiz[i].options[chosen.value]}<br>æ­£ç¢ºç­”æ¡ˆï¼š${quiz[i].answer}. ${quiz[i].options[quiz[i].answer]}<br>è©³è§£ï¼š${quiz[i].explanation}`;
        } else if (chosen && isAnswerCorrect(chosen.value, quiz[i].answer)) {
          explanation.classList.add('correct');
          correct++;
          quiz[i].isCorrect = true;
          explanationText = `<span class="result-correct">âœ“ æ­£ç¢ºï¼</span><br>æ¨™ç±¤ï¼š${formatTags(quiz[i].tags)}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(quiz[i].answer, quiz[i].options)}<br>è©³è§£ï¼š${quiz[i].explanation}`;
        } else {
          explanation.classList.add('incorrect');
          quiz[i].isCorrect = false;
          explanationText = `<span class="result-incorrect">âœ— éŒ¯èª¤ï¼</span><br>æ¨™ç±¤ï¼š${formatTags(quiz[i].tags)}<br>ä½ çš„ç­”æ¡ˆï¼š${chosen ? chosen.value + '. ' + quiz[i].options[chosen.value] : 'æœªä½œç­”'}<br>æ­£ç¢ºç­”æ¡ˆï¼š${quiz[i].answer}. ${quiz[i].options[quiz[i].answer]}<br>è©³è§£ï¼š${quiz[i].explanation}`;
        }
        explanation.innerHTML = explanationText.replace(/\n/g, '<br>');
        
        // éš±è—æäº¤ç­”æ¡ˆæŒ‰éˆ•
        submitBtn.style.display = 'none';
        
        // é¡¯ç¤ºè©³è§£
        explanation.style.display = 'block';
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºæœ€å¾Œä¸€é¡Œ
        const isLast = currentQuestion >= quiz.length - 1;
        
        if (!isLast) {
          // ä¸æ˜¯æœ€å¾Œä¸€é¡Œï¼Œæ›´æ–°æŒ‰éˆ•é¡¯ç¤º
          updateButtonDisplay();
        } else {
          // æ˜¯æœ€å¾Œä¸€é¡Œï¼Œéš±è—ææ—©äº¤å·æŒ‰éˆ•ï¼Œå»¶é²é¡¯ç¤ºæœ€çµ‚çµæœ
          document.getElementById('earlySubmitBtn').style.display = 'none';
          setTimeout(() => {
            showFinalResults();
          }, 1000);
        }
      }
    }
    
    function prevQuestion() {
      if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion(currentQuestion);
        
        // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
        updateButtonDisplay();
      }
    }

    function nextQuestion() {
      currentQuestion++;
      if (currentQuestion < quiz.length) {
        showQuestion(currentQuestion);
        // æ›´æ–°æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
        updateButtonDisplay();
      } else {
        showFinalResults();
      }
    }

    function updateButtonDisplay() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const earlySubmitBtn = document.getElementById('earlySubmitBtn');
      
      // æ§åˆ¶å›ä¸Šé¡ŒæŒ‰éˆ•é¡¯ç¤º
      if (currentQuestion > 0) {
        prevBtn.style.display = 'inline';
      } else {
        prevBtn.style.display = 'none';
      }
      
      // æ§åˆ¶ä¸‹ä¸€é¡ŒæŒ‰éˆ•é¡¯ç¤º - æ ¹æ“šç•¶å‰é¡Œç›®æ˜¯å¦å·²å›ç­”å’Œæ˜¯å¦ç‚ºæœ€å¾Œä¸€é¡Œ
      const isAnswered = quiz[currentQuestion].userAnswer !== undefined;
      const isLastQuestion = currentQuestion >= quiz.length - 1;
      
      if (isAnswered && !isLastQuestion) {
        nextBtn.style.display = 'inline';
        // ç•¶ä¸‹ä¸€é¡ŒæŒ‰éˆ•é¡¯ç¤ºæ™‚ï¼Œèª¿æ•´æŒ‰éˆ•é †åº
        if (currentQuestion > 0) {
          // å°‡å›ä¸Šé¡ŒæŒ‰éˆ•æ”¾åœ¨ä¸‹ä¸€é¡ŒæŒ‰éˆ•å‰é¢
          nextBtn.parentNode.insertBefore(prevBtn, nextBtn);
        }
      } else {
        nextBtn.style.display = 'none';
      }
      
      // ææ—©äº¤å·æŒ‰éˆ•é¡¯ç¤ºé‚è¼¯
      if (isLastQuestion && isAnswered) {
        earlySubmitBtn.style.display = 'none';
      } else {
        earlySubmitBtn.style.display = 'inline';
      }
    }

    async function earlySubmit() {
      const remainingQuestions = quiz.length - currentQuestion - 1;
      const confirmSubmit = await customConfirm(`ç¢ºå®šè¦ææ—©äº¤å·å—ï¼Ÿ<br><br>ç›®å‰é€²åº¦ï¼šç¬¬ ${currentQuestion + 1} é¡Œ / å…± ${quiz.length} é¡Œ<br>å‰©é¤˜é¡Œæ•¸ï¼š${remainingQuestions} é¡Œ<br><br>æœªä½œç­”çš„é¡Œç›®å°‡è¨ˆç‚ºéŒ¯èª¤ã€‚`);
      
      if (confirmSubmit) {
        // è™•ç†ç•¶å‰é¡Œç›®ï¼ˆå¦‚æœé‚„æ²’æäº¤ç­”æ¡ˆçš„è©±ï¼‰
        const currentExplanation = document.getElementById(`explanation${currentQuestion}`);
        if (currentExplanation && !currentExplanation.dataset.answered) {
          // ç•¶å‰é¡Œç›®é‚„æ²’æäº¤ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡ç­”æ¡ˆ
          const chosen = document.querySelector(`input[name='q${currentQuestion}']:checked`);
          quiz[currentQuestion].userAnswer = chosen ? chosen.value : null;
          
          if (chosen && chosen.value === quiz[currentQuestion].answer) {
            quiz[currentQuestion].isCorrect = true;
            correct++;
          } else {
            quiz[currentQuestion].isCorrect = false;
          }
        }
        
        // æ¨™è¨˜æœªé–‹å§‹çš„é¡Œç›®ç‚ºæœªä½œç­”
        for (let i = currentQuestion + 1; i < quiz.length; i++) {
          quiz[i].userAnswer = null;
          quiz[i].isCorrect = false;
        }
        
        // ç›´æ¥é¡¯ç¤ºæœ€çµ‚çµæœ
        showFinalResults();
      }
    }

    function showBrowseResults() {
      // åœç”¨ç©ºç™½éµåŠŸèƒ½
      canUseSpacebar = false;
      
      // éš±è—æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•å’Œé€²åº¦æ¢
      document.getElementById('stepControls').classList.add('hidden');
      document.getElementById('progressInfo').classList.add('hidden');
      document.getElementById('submitBtn').classList.add('hidden');
      document.getElementById('quiz').innerHTML = '';
      
      const total = quiz.length;
      
      // æ§‹å»ºç€è¦½æ¨¡å¼çš„è©³ç´°çµæœ
      let detailedResults = '';
      
      quiz.forEach((q, idx) => {
        // æª¢æŸ¥æ˜¯å¦ç‚ºäº”å€‹é¸é …çš„é¡Œç›®ï¼ˆé€åˆ†é¡Œï¼‰
        const optionCount = Object.keys(q.options).length;
        const isBonusQuestion = optionCount === 5;
        
        let questionResult = `ç¬¬ ${idx + 1} é¡Œï¼š${q.question}\n`;
        // å¦‚æœæœ‰åœ–ç‰‡ï¼Œæ·»åŠ åœ–ç‰‡HTML
        if (q.images && q.images.length > 0) {
          questionResult += `${generateImageHTML(q.images)}\n`;
        }
        questionResult += `æ¨™ç±¤ï¼š${formatTags(q.tags)}\né¸é …ï¼š\n`;
        Object.entries(q.options).forEach(([key, value]) => {
          questionResult += `  ${key}. ${value}\n`;
        });
        questionResult += `æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}${isBonusQuestion ? ' ï¼ˆé€åˆ†é¡Œï¼‰' : ''}\nè©³è§£ï¼š${q.explanation}\n${'-'.repeat(30)}\n\n`;
        
        // çµ¦æ¯å€‹é¡Œç›®çµæœæ·»åŠ åŒ…è£div
        detailedResults += `<div class="question-result browse-mode" data-question-index="${idx}">${questionResult}</div>`;
      });
      
      // é–‹å§‹æ§‹å»ºHTMLå…§å®¹
      let htmlSummary = '';
  
      // æ·»åŠ ç­”é¡Œè¨˜éŒ„ç®¡ç†å€åŸŸåˆ°çµæœé é¢ï¼ˆç€è¦½æ¨¡å¼ä¸è¨˜éŒ„ç­”é¡Œçµæœï¼Œä½†ä¿ç•™è¼‰å…¥å’Œè¦–è¦ºåŒ–åŠŸèƒ½ï¼‰
      let recordManagementHTML = `
        <div class="record-management">
          <div class="record-section">
            <h3>ğŸ“‚ è¼‰å…¥è¨˜éŒ„</h3>
            <div class="file-input-wrapper">
              <input type="file" accept=".json" class="file-input" onchange="loadUserProgress(this.files[0])">
              <button class="file-input-btn">é¸æ“‡è¨˜éŒ„æª”</button>
            </div>
            <div class="record-status info" id="recordStatus">å°šæœªè¼‰å…¥è¨˜éŒ„æª”æ¡ˆ</div>
          </div>
          
          <div class="record-section">
            <h3>ğŸ“Š è¦–è¦ºåŒ–åˆ†æ</h3>
            <div class="download-buttons">
              <button id="visualizationBtn" class="visualization-btn" onclick="openVisualization()" disabled>ç­”é¡Œç‹€æ³è¦–è¦ºåŒ–</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              ç€è¦½æ¨¡å¼ä¸æœƒè¨˜éŒ„ç­”é¡Œçµæœ
            </div>
          </div>
        </div>
      `;
      
      htmlSummary = recordManagementHTML + htmlSummary;
          
      // ç€è¦½æ¨¡å¼å¾Œåˆå§‹åŒ–æ­·å²è¨˜éŒ„ä¸‹è¼‰æŒ‰éˆ•ç‹€æ…‹
      setTimeout(() => {
        updateHistoryButtonState();
        updateVisualizationButtonState();
      }, 100);
      
      // æ·»åŠ é¡Œç›®ç¸½æ•¸èªªæ˜
      htmlSummary += `<div style="background: #e7f3ff; border: 1px solid #b8daff; border-radius: 5px; padding: 15px; margin: 15px 0; text-align: center;">
        <h3 style="margin: 0 0 5px 0; color: #0c5460;">ğŸ“– ç€è¦½æ¨¡å¼</h3>
        <p style="margin: 0; color: #0c5460;">ç¸½å…± ${total} é¡Œç›®å…§å®¹å’Œè©³è§£</p>
      </div>`;
      
      // æ·»åŠ è©³ç´°çµæœ
      htmlSummary += `<div style="white-space: pre-wrap; font-family: monospace;">ã€é¡Œç›®å…§å®¹èˆ‡è©³è§£ã€‘\n${'='.repeat(50)}\n\n`;
      
      htmlSummary += detailedResults + `</div><br>`;
      
      // æ·»åŠ é‡æ–°é–‹å§‹æŒ‰éˆ•
      htmlSummary += `<button onclick="resetQuiz()" style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°é–‹å§‹</button>`;
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = htmlSummary;
    }

    function showFinalResults() {
      // è¨˜éŒ„ç•¶å‰æ¸¬é©—çµæœ
  recordCurrentTest();
  
  // åœç”¨ç©ºç™½éµåŠŸèƒ½
      canUseSpacebar = false;
      
      // éš±è—æ‰€æœ‰æ§åˆ¶æŒ‰éˆ•å’Œé€²åº¦æ¢
      document.getElementById('stepControls').classList.add('hidden');
      document.getElementById('progressInfo').classList.add('hidden');
      document.getElementById('quiz').innerHTML = '';
      
      // é‡ç½®é”™é¢˜æ˜¾ç¤ºçŠ¶æ€
      showingWrongAnswersOnly = false;
      wrongQuestionIndices = [];
      
      const total = quiz.length;
      const wrong = total - correct;
      
      // æ„å»ºè¯¦ç»†ç»“æœå¹¶è®°å½•é”™é¢˜ç´¢å¼•
      let detailedResults = '';
      
      quiz.forEach((q, idx) => {
        // æª¢æŸ¥æ˜¯å¦ç‚ºäº”å€‹é¸é …çš„é¡Œç›®ï¼ˆé€åˆ†é¡Œï¼‰
        const optionCount = Object.keys(q.options).length;
        const isBonusQuestion = optionCount === 5;
        
        let isCorrect;
        if (isBonusQuestion && q.userAnswer) {
          // é€åˆ†é¡Œï¼šæœ‰ä½œç­”å°±æ˜¯æ­£ç¢º
          isCorrect = true;
        } else {
          // ä¸€èˆ¬é¡Œç›®ï¼šç­”æ¡ˆè¦ç¬¦åˆ
          isCorrect = isAnswerCorrect(q.userAnswer, q.answer);
        }
        
        // å¦‚æœç­”é”™äº†ï¼Œè®°å½•ç´¢å¼•
        if (!isCorrect) {
          wrongQuestionIndices.push(idx);
        }
        
        const resultText = isCorrect ? (isBonusQuestion ? 'âœ“ æ­£ç¢ºï¼ˆé€åˆ†é¡Œï¼‰' : 'âœ“ æ­£ç¢º') : 'âœ— éŒ¯èª¤';
        const resultClass = isCorrect ? 'result-correct' : 'result-incorrect';
        
        let questionResult = `ç¬¬ ${idx + 1} é¡Œï¼š${q.question}\n`;
        // å¦‚æœæœ‰åœ–ç‰‡ï¼Œæ·»åŠ åœ–ç‰‡HTML
        if (q.images && q.images.length > 0) {
          questionResult += `${generateImageHTML(q.images)}\n`;
        }
        questionResult += `æ¨™ç±¤ï¼š${formatTags(q.tags)}\né¸é …ï¼š\n`;
        Object.entries(q.options).forEach(([key, value]) => {
          questionResult += `  ${key}. ${value}\n`;
        });
        questionResult += `ä½ çš„ç­”æ¡ˆï¼š${q.userAnswer ? q.userAnswer + '. ' + q.options[q.userAnswer] : "æœªä½œç­”"}\næ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}\nçµæœï¼š<span class="${resultClass}">${resultText}</span>\nè©³è§£ï¼š${q.explanation}\n${'-'.repeat(30)}\n\n`;
        
        // ç»™æ¯ä¸ªé¢˜ç›®ç»“æœæ·»åŠ åŒ…è£…divï¼Œç”¨äºæ˜¾ç¤º/éšè—æ§åˆ¶
        detailedResults += `<div class="question-result" data-question-index="${idx}" data-is-correct="${isCorrect}">${questionResult}</div>`;
      });
      
      // å¼€å§‹æ„å»ºHTMLå†…å®¹ï¼Œé”™é¢˜åˆ‡æ¢æŒ‰é’®æ”¾åœ¨æœ€å‰é¢
      let htmlSummary = '';
  
  // æ·»åŠ ç­”é¡Œè¨˜éŒ„ç®¡ç†å€åŸŸåˆ°çµæœé é¢
  let recordManagementHTML = `
    <div class="record-management">
      <div class="record-section">
        <h3>ğŸ“‚ è¼‰å…¥è¨˜éŒ„</h3>
        <div class="file-input-wrapper">
          <input type="file" accept=".json" class="file-input" onchange="loadUserProgress(this.files[0])">
          <button class="file-input-btn">é¸æ“‡è¨˜éŒ„æª”</button>
        </div>
        <div class="record-status info" id="recordStatus">å°šæœªè¼‰å…¥è¨˜éŒ„æª”æ¡ˆ</div>
      </div>
      
      <div class="record-section">
        <h3>ğŸ’¾ ä¸‹è¼‰è¨˜éŒ„</h3>
        <div class="download-buttons">
          <button class="current-record-btn" onclick="downloadCurrentProgress()">ä¸‹è¼‰ç›®å‰ä½œç­”è¨˜éŒ„</button>
          <button id="historyRecordBtn" class="history-record-btn" onclick="downloadHistoryProgress()" disabled>ä¸‹è¼‰æ­·å²å®Œæ•´è¨˜éŒ„</button>
        </div>
      </div>
      
      <div class="record-section">
        <h3>ğŸ“Š è¦–è¦ºåŒ–åˆ†æ</h3>
        <div class="download-buttons">
          <button id="visualizationBtn" class="visualization-btn" onclick="openVisualization()" disabled>ç­”é¡Œç‹€æ³è¦–è¦ºåŒ–</button>
        </div>
      </div>
    </div>
  `;
  
  htmlSummary = recordManagementHTML + htmlSummary;
      
      // æ¸¬é©—å®Œæˆå¾Œåˆå§‹åŒ–æ­·å²è¨˜éŒ„ä¸‹è¼‰æŒ‰éˆ•ç‹€æ…‹
      setTimeout(() => {
        updateHistoryButtonState();
      }, 100);
      
      // æ·»åŠ é”™é¢˜åˆ‡æ¢æŒ‰é’®ï¼ˆåªæœ‰å½“æœ‰é”™é¢˜æ—¶æ‰æ˜¾ç¤ºï¼‰
      if (wrongQuestionIndices.length > 0) {
        htmlSummary += `<button id="wrongAnswersToggle" class="wrong-answers-toggle" onclick="toggleWrongAnswers()">åªé¡¯ç¤ºéŒ¯é¡Œ (${wrongQuestionIndices.length} é¡Œ)</button><br><br>`;
      }
      
      // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯å’Œè¯¦ç»†ç»“æœ
      htmlSummary += `<div style="white-space: pre-wrap; font-family: monospace;">ç¸½å…± ${total} é¡Œï¼Œæ­£ç¢º ${correct} é¡Œï¼ŒéŒ¯èª¤ ${wrong} é¡Œï¼Œå¾—åˆ†ï¼š${Math.round((correct / total) * 100)} åˆ†\n\nã€è©³ç´°ç­”é¡Œçµæœã€‘\n${'='.repeat(50)}\n\n`;
      
      htmlSummary += detailedResults + `</div><br>`;
      
      // æ·»åŠ é‡æ–°å¼€å§‹æŒ‰é’®
      htmlSummary += `<button onclick="resetQuiz()" style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">é‡æ–°é–‹å§‹</button>`;
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = htmlSummary;
    }


    function toggleWrongAnswers() {
      const toggleBtn = document.getElementById('wrongAnswersToggle');
      const questionResults = document.querySelectorAll('.question-result');
      
      if (!showingWrongAnswersOnly) {
        // åˆ‡æ¢åˆ°åªæ˜¾ç¤ºé”™é¢˜æ¨¡å¼
        showingWrongAnswersOnly = true;
        toggleBtn.textContent = `é¡¯ç¤ºå…¨éƒ¨é¡Œç›® (å…± ${quiz.length} é¡Œ)`;
        toggleBtn.classList.add('show-all');
        
        // éšè—æ‰€æœ‰æ­£ç¡®çš„é¢˜ç›®
        questionResults.forEach(result => {
          const isCorrect = result.dataset.isCorrect === 'true';
          if (isCorrect) {
            result.classList.add('hidden');
          }
        });
        
      } else {
        // åˆ‡æ¢å›æ˜¾ç¤ºå…¨éƒ¨é¢˜ç›®æ¨¡å¼
        showingWrongAnswersOnly = false;
        toggleBtn.textContent = `åªé¡¯ç¤ºéŒ¯é¡Œ (${wrongQuestionIndices.length} é¡Œ)`;
        toggleBtn.classList.remove('show-all');
        
        // æ˜¾ç¤ºæ‰€æœ‰é¢˜ç›®
        questionResults.forEach(result => {
          result.classList.remove('hidden');
        });
      }
    }

    function resetQuiz() {
      // ä¿å­˜é¦–é è¨˜éŒ„ç‹€æ…‹
      const savedHomepageState = { ...homepageRecordState };
      const savedUserProgress = { ...userProgress };
      const savedHasLoadedProgress = hasLoadedProgress;
      const savedLoadedFileName = loadedFileName;
      
      // å®Œå…¨é‡ç½®æ‰€æœ‰è®Šæ•¸åˆ°åˆå§‹ç‹€æ…‹
      // é‡ç½®æ¸¬é©—ç›¸é—œè®Šæ•¸ï¼ˆä¿ç•™ç­”é¡Œè¨˜éŒ„å’Œè¼‰å…¥ç‹€æ…‹ï¼‰
  // userProgressã€hasLoadedProgressã€loadedFileName ä¿æŒä¸è®Š
  
  quiz = [];
      currentQuestion = 0;
      correct = 0;
      isStepMode = false;
      canUseSpacebar = false;
      hasWarned = false;
      showingWrongAnswersOnly = false;
      wrongQuestionIndices = [];
      
      // æ¸…é™¤æ‰€æœ‰ radio button çš„é¸æ“‡å’Œdisabledç‹€æ…‹
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
        radio.disabled = false;
      });
      
      // å®Œå…¨é‡ç½®æ‰€æœ‰ checkbox åˆ°åˆå§‹æœªé¸æ“‡ç‹€æ…‹
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // é‡ç½®æ‰€æœ‰é¡Œæ•¸è¼¸å…¥æ¡†çš„å€¼ç‚ºåˆå§‹é è¨­å€¼
      document.querySelectorAll('.subject-count input[type="number"]').forEach(input => {
        // æ ¹æ“šä¸åŒç§‘ç›®è¨­å®šé è¨­å€¼
        input.value = '1';
      });
      
      // éš±è—æ‰€æœ‰é¡Œæ•¸è¼¸å…¥æ¡†ï¼ˆå›åˆ°åˆå§‹ç‹€æ…‹ï¼‰
      document.querySelectorAll('.subject-count').forEach(countDiv => {
        countDiv.style.display = 'none';
      });
      
      // é‡ç½®ä¸‹æ‹‰é¸å–®ç‚ºé è¨­å€¼ï¼ˆç¬¬ä¸€å€‹é¸é …ï¼‰
      document.getElementById('mode').selectedIndex = 0;
      document.getElementById('questionOrder').selectedIndex = 0;
      
      // æ¸…é™¤æ‰€æœ‰è­¦å‘Šè¨Šæ¯
      document.querySelectorAll('.warning-message').forEach(warning => {
        warning.style.display = 'none';
      });
      
      // å®Œå…¨æ¸…é™¤æ‰€æœ‰è©³è§£å…§å®¹å’Œç‹€æ…‹
      document.querySelectorAll('.explanation').forEach(explanation => {
        explanation.style.display = 'none';
        explanation.classList.remove('correct', 'incorrect');
        explanation.innerHTML = '';
        if (explanation.dataset.answered) {
          delete explanation.dataset.answered;
        }
      });
      
      // é‡ç½®æ‰€æœ‰è¦–è¦ºåŒ–æŒ‰éˆ•åˆ°æœªé¸æ“‡ç‹€æ…‹
      document.querySelectorAll('.visual-checkbox').forEach(element => {
        element.classList.remove('selected');
      });
      
      // é‡æ–°é¡¯ç¤ºè¨­å®šå€åŸŸå’Œæ¨™é¡Œå€åŸŸï¼ˆå›åˆ°ä¸»é é¢ç‹€æ…‹ï¼‰
      document.getElementById('setupSection').classList.remove('hidden');
      document.getElementById('headerSection').classList.remove('hidden');
      
      // éš±è—æ‰€æœ‰æ¸¬é©—ç›¸é—œå€åŸŸ
      document.getElementById('progressInfo').classList.add('hidden');
      document.getElementById('stepControls').classList.add('hidden');
      document.getElementById('submitBtn').classList.add('hidden');
      
      // å®Œå…¨æ¸…ç©ºæ¸¬é©—å…§å®¹å’Œçµæœ
      document.getElementById('quiz').innerHTML = '';
      document.getElementById('result').innerHTML = '';
      
      // é‡ç½®æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹åˆ°åˆå§‹ç‹€æ…‹
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('prevBtn').style.display = 'none';
      document.getElementById('earlySubmitBtn').style.display = 'none';
      
      // æ¸…é™¤é€²åº¦é¡¯ç¤ºï¼Œå›åˆ°åˆå§‹å€¼
      document.getElementById('currentQuestionNum').innerText = '1';
      document.getElementById('totalQuestions').innerText = '0';
      
      // é‡ç½®quizé™£åˆ—ä¸­æ¯å€‹é¡Œç›®çš„ç”¨æˆ¶ç­”æ¡ˆå’Œæ­£ç¢ºæ€§æ¨™è¨˜
      if (questions && questions.length > 0) {
        questions.forEach(q => {
          if (q.userAnswer !== undefined) delete q.userAnswer;
          if (q.isCorrect !== undefined) delete q.isCorrect;
        });
      }
      
      // æ¸…é™¤ä»»ä½•æ®˜ç•™çš„æ¨£å¼é¡åˆ¥
      document.querySelectorAll('.question-block').forEach(block => {
        block.remove();
      });
      
      // ç§»é™¤ä»»ä½•å‹•æ…‹æ·»åŠ çš„å…ƒç´ 
      document.querySelectorAll('.question-result').forEach(result => {
        result.remove();
      });
      
      // ç§»é™¤éŒ¯é¡Œåˆ‡æ›æŒ‰éˆ•ç­‰å‹•æ…‹å…ƒç´ 
      const wrongToggle = document.getElementById('wrongAnswersToggle');
      if (wrongToggle) {
        wrongToggle.remove();
      }
      
      // é‡æ–°å•Ÿç”¨æ‰€æœ‰è¡¨å–®å…ƒç´ 
      document.querySelectorAll('select, input, button').forEach(element => {
        element.disabled = false;
      });
      
      // ç¢ºä¿è¦–è¦ºæ¨£å¼åœ¨çŸ­æš«å»¶é²å¾Œæ›´æ–°ï¼Œå®Œå…¨å›åˆ°åˆå§‹ç‹€æ…‹
      setTimeout(() => {
        updateVisualStyles();
        // ç¢ºä¿é é¢æ»¾å‹•åˆ°é ‚éƒ¨
        window.scrollTo(0, 0);
        console.log('æ¸¬é©—ç³»çµ±å·²å®Œå…¨é‡ç½®åˆ°åˆå§‹ä¸»é é¢ç‹€æ…‹');
      }, 50);
      
      // ç¢ºä¿æ²’æœ‰ä»»ä½•éºç•™çš„äº‹ä»¶ç›£è½å™¨æˆ–ç‹€æ…‹
      hasWarned = false;
      showingWrongAnswersOnly = false;
      wrongQuestionIndices = [];
      
      // æ¢å¾©é¦–é è¨˜éŒ„ç‹€æ…‹
      homepageRecordState = savedHomepageState;
      userProgress = savedUserProgress;
      hasLoadedProgress = savedHasLoadedProgress;
      loadedFileName = savedLoadedFileName;
      
      // æ¢å¾©UIç‹€æ…‹
      setTimeout(() => {
        if (homepageRecordState.hasLoaded) {
          updateHomepageRecordStatus('success', `âœ… å·²è¼‰å…¥ï¼š${homepageRecordState.fileName}.json (${homepageRecordState.recordCount} é¡Œè¨˜éŒ„)`);
        } else {
          updateHomepageRecordStatus('info', 'å°šæœªè¼‰å…¥è¨˜éŒ„æª”æ¡ˆ');
        }
        updateHomepageVisualizationButton();
        
        // ç¢ºä¿é¦–é è¨˜éŒ„å€åŸŸé¡¯ç¤º
        const homepageSection = document.getElementById('homepageRecordSection');
        if (homepageSection) {
          homepageSection.style.display = 'block';
        }
      }, 100);
    }

    function showAllQuestions() {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = '';
      quiz.forEach((q, i) => {
        const qBlock = document.createElement('div');
        qBlock.className = 'question-block';
        qBlock.innerHTML = `
          <h3>ç¬¬ ${i + 1} é¡Œ <span class="question-tags">${formatTags(q.tags)}</span></h3>
          <p>${q.question}</p>
          ${q.images ? generateImageHTML(q.images) : ''}
          ${Object.entries(q.options).map(([key, value]) => `<label><input type="radio" name="q${i}" value="${key}"> ${key}. ${value}</label><br>`).join('')}
          <div class="explanation" id="explanation${i}">${q.explanation}</div>
        `;
        quizDiv.appendChild(qBlock);
      });
    }

    function submitQuiz() {
      correct = 0; // é‡ç½®è¨ˆæ•¸å™¨
      quiz.forEach((q, i) => {
        const chosen = document.querySelector(`input[name='q${i}']:checked`);
        const explanation = document.getElementById(`explanation${i}`);
        explanation.style.display = 'block';
        
        q.userAnswer = chosen ? chosen.value : null;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºäº”å€‹é¸é …çš„é¡Œç›®ï¼ˆé€åˆ†é¡Œï¼‰
        const optionCount = Object.keys(q.options).length;
        const isBonusQuestion = optionCount === 5;
        
        if (isBonusQuestion && chosen) {
          // äº”å€‹é¸é …çš„é¡Œç›®ï¼Œæœ‰é¸å°±å°
          explanation.classList.add('correct');
          explanation.innerHTML = `<span class="result-correct">âœ“ æ­£ç¢ºï¼ï¼ˆé€åˆ†é¡Œï¼‰</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>ä½ çš„ç­”æ¡ˆï¼š${chosen.value}. ${q.options[chosen.value]}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
          correct++;
          q.isCorrect = true; // æ¨™è¨˜ç‚ºæ­£ç¢ºï¼Œç”¨æ–¼æœ€çµ‚çµæœé¡¯ç¤º
        } else if (chosen && isAnswerCorrect(chosen.value, q.answer)) {
          explanation.classList.add('correct');
          explanation.innerHTML = `<span class="result-correct">âœ“ æ­£ç¢ºï¼</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
          correct++;
          q.isCorrect = true;
        } else {
          explanation.classList.add('incorrect');
          explanation.innerHTML = `<span class="result-incorrect">âœ— éŒ¯èª¤ï¼</span><br>æ¨™ç±¤ï¼š${formatTags(q.tags)}<br>ä½ çš„ç­”æ¡ˆï¼š${chosen ? chosen.value + '. ' + q.options[chosen.value] : 'æœªä½œç­”'}<br>æ­£ç¢ºç­”æ¡ˆï¼š${formatCorrectAnswer(q.answer, q.options)}<br>è©³è§£ï¼š${q.explanation}`;
          q.isCorrect = false;
        }
      });
      
      // éš±è—æäº¤æŒ‰éˆ•
      document.getElementById('submitBtn').classList.add('hidden');
      
      // å»¶é²é¡¯ç¤ºæœ€çµ‚çµæœï¼Œè®“ç”¨æˆ¶å…ˆçœ‹åˆ°å„é¡Œè§£ç­”
      setTimeout(() => {
        showFinalResults();
      }, 1000);
    }
  
    // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–è¦–è¦ºæ¨£å¼
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => updateVisualStyles(), 50);
    });

    // åœ–ç‰‡ç›¸é—œå‡½æ•¸
    function showImageOverlay(src) {
      const overlay = document.getElementById('imageOverlay');
      const overlayImage = document.getElementById('overlayImage');
      overlayImage.src = src;
      overlay.style.display = 'flex';
    }
    
    function closeImageOverlay() {
      const overlay = document.getElementById('imageOverlay');
      overlay.style.display = 'none';
    }
    
    // ESCéµé—œé–‰åœ–ç‰‡è¦†è“‹å±¤
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeImageOverlay();
      }
    });
    
    function generateImageHTML(images) {
      if (!images || images.length === 0) {
        return '';
      }
      
      let imageHTML = '<div class="question-images">';
      images.forEach(imagePath => {
        imageHTML += `<img src="${imagePath}" alt="é¡Œç›®åœ–ç‰‡" onclick="showImageOverlay('${imagePath}')">`;
      });
      imageHTML += '</div>';
      return imageHTML;
    }
  
    // ========== è¦–è¦ºåŒ–åŠŸèƒ½ç›¸é—œ ==========
    
    // é¡Œç›®IDè§£æå‡½æ•¸
    function parseQuestionId(questionId) {
      const idStr = questionId.toString().padStart(7, '0');
      
      const year = parseInt(idStr.substring(0, 3));
      const term = parseInt(idStr.substring(3, 4));
      const examType = parseInt(idStr.substring(4, 5));
      const questionNum = parseInt(idStr.substring(5, 7));
      
      // æ”¯æ´é†«å­¸(ä¸€)åˆ°é†«å­¸(å…­)
      const examNames = {
        1: 'ä¸€',
        2: 'äºŒ',
        3: 'ä¸‰',
        4: 'å››',
        5: 'äº”',
        6: 'å…­'
      };
      const examName = examNames[examType] || 'æœªçŸ¥';
      const displayQuestionNum = questionNum === 0 ? 100 : questionNum;
      
      return {
        year: year,
        term: term,
        examType: examName,
        questionNumber: displayQuestionNum,
        fullName: `${year}-${term}(${examName})`
      };
    }

    // ç”Ÿæˆå¹´åº¦åˆ—è¡¨
    function generateYearList() {
      const years = [];
      // 114å¹´
      years.push({
        year: 114,
        term: 2,
        medicine3: "114-2(ä¸‰)",
        medicine4: "114-2(å››)",
        medicine5: "114-2(äº”)",
        medicine6: "114-2(å…­)"
      });
      years.push({
        year: 114,
        term: 1,
        medicine3: "114-1(ä¸‰)",
        medicine4: "114-1(å››)",
        medicine5: "114-1(äº”)",
        medicine6: "114-1(å…­)"
      });
      
      // 113-110å¹´æ¯å¹´éƒ½æœ‰æœŸ1å’ŒæœŸ2
      for (let year = 113; year >= 110; year--) {
        years.push({
          year: year,
          term: 2,
          medicine3: `${year}-2(ä¸‰)`,
          medicine4: `${year}-2(å››)`,
          medicine5: `${year}-2(äº”)`,
          medicine6: `${year}-2(å…­)`
        });
        years.push({
          year: year,
          term: 1,
          medicine3: `${year}-1(ä¸‰)`,
          medicine4: `${year}-1(å››)`,
          medicine5: `${year}-1(äº”)`,
          medicine6: `${year}-1(å…­)`
        });
      }
      
      return years; // 10ä»½è€ƒå·ï¼ˆ114-2 åˆ° 110-1ï¼‰
    }

    // æ›´æ–°è¦–è¦ºåŒ–æŒ‰éˆ•ç‹€æ…‹
    function updateVisualizationButtonState() {
      const visualizationBtn = document.getElementById('visualizationBtn');
      
      if (!visualizationBtn) return;
      
      // æª¢æŸ¥æ˜¯å¦æœ‰ç­”é¡Œè¨˜éŒ„
      const hasRecords = userProgress && Object.keys(userProgress).filter(key => key !== 'metadata').length > 0;
      
      if (hasRecords) {
        visualizationBtn.disabled = false;
        visualizationBtn.style.backgroundColor = '#17a2b8';
        visualizationBtn.style.cursor = 'pointer';
      } else {
        visualizationBtn.disabled = true;
        visualizationBtn.style.backgroundColor = '#6c757d';
        visualizationBtn.style.cursor = 'not-allowed';
      }
    }

    // é–‹å•Ÿè¦–è¦ºåŒ–è¦–çª—
    function openVisualization() {
      if (!userProgress || Object.keys(userProgress).filter(key => key !== 'metadata').length === 0) {
        alert('æ²’æœ‰å¯è¦–è¦ºåŒ–çš„ç­”é¡Œè¨˜éŒ„');
        return;
      }
      
      processVisualizationData();
      document.getElementById('visualizationModal').style.display = 'flex';
      document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
    }

    // é—œé–‰è¦–è¦ºåŒ–è¦–çª—
    function closeVisualization() {
      document.getElementById('visualizationModal').style.display = 'none';
      document.body.style.overflow = 'auto'; // æ¢å¾©èƒŒæ™¯æ»¾å‹•
    }

    // ESCéµé—œé–‰è¦–è¦ºåŒ–è¦–çª—
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeVisualization();
      }
    });

    // è™•ç†è¦–è¦ºåŒ–æ•¸æ“š
    function processVisualizationData() {
      // ç§»é™¤metadata
      const questionData = { ...userProgress };
      delete questionData.metadata;

      // è§£ææ‰€æœ‰é¡Œç›®
      const parsedQuestions = {};
      Object.keys(questionData).forEach(questionId => {
        const parsed = parseQuestionId(questionId);
        const key = `${parsed.year}-${parsed.term}(${parsed.examType})`;
        
        if (!parsedQuestions[key]) {
          parsedQuestions[key] = {};
        }
        
        parsedQuestions[key][parsed.questionNumber] = questionData[questionId];
      });

      // ç”Ÿæˆè¦–è¦ºåŒ–ï¼ˆç§»é™¤çµ±è¨ˆè³‡è¨Šï¼‰
      generateVisualizationDisplay(parsedQuestions);
    }



    // ç”Ÿæˆè¦–è¦ºåŒ–é¡¯ç¤º
    function generateVisualizationDisplay(parsedQuestions) {
      const container = document.getElementById('visualizationContent');
      const yearList = generateYearList();
      
      // åˆ†é›¢é†«å­¸(ä¸‰)å’Œé†«å­¸(å››)
      const medicine3Years = yearList.map(y => y.medicine3);
      const medicine4Years = yearList.map(y => y.medicine4);

      let html = '';

      // é†«å­¸(ä¸‰)éƒ¨åˆ†
      html += generateVisualizationExamSection('é†«å­¸(ä¸‰)', medicine3Years, parsedQuestions);
      
      // é†«å­¸(å››)éƒ¨åˆ†
      html += generateVisualizationExamSection('é†«å­¸(å››)', medicine4Years, parsedQuestions, true);

      container.innerHTML = html;
    }

    // ç”Ÿæˆè€ƒè©¦ç§‘ç›®å€å¡Š
    function generateVisualizationExamSection(title, years, parsedQuestions, isMedicine2 = false) {
      let html = `
        <div class="exam-section">
          <div class="exam-header ${isMedicine2 ? 'medicine-2' : ''}">${title} è©¦å·</div>
          <div class="year-grid">
      `;

      years.forEach(yearName => {
        html += `
          <div class="year-column">
            <div class="year-header">${yearName}</div>
            <div class="questions-container">
        `;

        const questionsForYear = parsedQuestions[yearName] || {};
        
        if (Object.keys(questionsForYear).length === 0) {
          html += '<div class="empty-state">æš«ç„¡ç­”é¡Œè¨˜éŒ„</div>';
        } else {
          // ç”Ÿæˆ1-100é¡Œ
          for (let i = 1; i <= 100; i++) {
            const attempts = questionsForYear[i] || [];
            html += generateVisualizationQuestionRow(i, attempts);
          }
        }

        html += `
            </div>
          </div>
        `;
      });

      html += `
          </div>
        </div>
      `;

      return html;
    }

    // ç”Ÿæˆé¡Œç›®è¡Œ
    function generateVisualizationQuestionRow(questionNum, attempts) {
      let answerHistory = '';
      
      if (attempts.length === 0) {
        answerHistory = '<span style="color: #dee2e6;">â€”</span>';
      } else {
        attempts.forEach(attempt => {
          if (attempt === 1) {
            answerHistory += '<span class="answer-symbol correct-symbol">âœ…</span>';
          } else if (attempt === 0) {
            answerHistory += '<span class="answer-symbol incorrect-symbol">âŒ</span>';
          }
        });
      }

      return `
        <div class="question-row">
          <span class="question-number">é¡Œ${questionNum}:</span>
          <div class="answer-history">${answerHistory}</div>
        </div>
      `;
    }



  
    // ========== é¦–é è¨˜éŒ„æª”ç®¡ç†åŠŸèƒ½ ==========
    
    // é¦–é è¨˜éŒ„æª”ç‹€æ…‹
    let homepageRecordState = {
      hasLoaded: false,
      fileName: '',
      recordCount: 0
    };
    
    // è¼‰å…¥é¦–é è¨˜éŒ„æª” - ç›´æ¥èª¿ç”¨ loadUserProgress ä¸¦æ›´æ–°é¦–é ç‹€æ…‹
    function loadHomepageRecord(file) {
      if (!file) return;
      
      // ç›´æ¥èª¿ç”¨åŸå§‹çš„ loadUserProgress å‡½æ•¸
      loadUserProgress(file);
      
      // é¡å¤–çš„é¦–é ç‹€æ…‹æ›´æ–°
      setTimeout(() => {
        if (hasLoadedProgress && loadedFileName) {
          // æ›´æ–°é¦–é è¨˜éŒ„ç‹€æ…‹
          const recordCount = Object.keys(userProgress).filter(key => key !== 'metadata').length;
          homepageRecordState = {
            hasLoaded: true,
            fileName: loadedFileName,
            recordCount: recordCount
          };
          
          updateHomepageRecordStatus('success', `âœ… å·²è¼‰å…¥ï¼š${loadedFileName}.json (${recordCount} é¡Œè¨˜éŒ„)`);
        } else {
          // è¼‰å…¥å¤±æ•—
          homepageRecordState = {
            hasLoaded: false,
            fileName: '',
            recordCount: 0
          };
          updateHomepageRecordStatus('error', "âŒ æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„è¨˜éŒ„æª”");
        }
        
        updateHomepageVisualizationButton();
      }, 200);
    }
    
    // æ›´æ–°é¦–é è¨˜éŒ„ç‹€æ…‹é¡¯ç¤º
    function updateHomepageRecordStatus(type, message) {
      const statusElement = document.getElementById('homepageRecordStatus');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `homepage-record-status ${type}`;
      }
    }
    
    // æ›´æ–°é¦–é è¦–è¦ºåŒ–æŒ‰éˆ•ç‹€æ…‹
    function updateHomepageVisualizationButton() {
      const btn = document.getElementById('homepageVisualizationBtn');
      if (!btn) return;
      
      const hasRecords = homepageRecordState.hasLoaded || 
                        (userProgress && Object.keys(userProgress).filter(key => key !== 'metadata').length > 0);
      
      btn.disabled = !hasRecords;
      
      if (hasRecords) {
        btn.style.backgroundColor = '#17a2b8';
        btn.style.cursor = 'pointer';
      } else {
        btn.style.backgroundColor = '#6c757d';
        btn.style.cursor = 'not-allowed';
      }
    }
    
    // é–‹å•Ÿé¦–é è¦–è¦ºåŒ–
    function openHomepageVisualization() {
      if (!userProgress || Object.keys(userProgress).filter(key => key !== 'metadata').length === 0) {
        updateHomepageRecordStatus('error', 'âŒ æ²’æœ‰å¯è¦–è¦ºåŒ–çš„ç­”é¡Œè¨˜éŒ„');
        return;
      }
      
      // é‡ç”¨ç¾æœ‰çš„è¦–è¦ºåŒ–åŠŸèƒ½
      processVisualizationData();
      document.getElementById('visualizationModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    

    
    // ========== é†«å­¸å¹´ç´šåˆ‡æ›åŠŸèƒ½ ==========
    
    // åˆ‡æ›é†«å­¸å¹´ç´šé¡¯ç¤º
    function switchGrade(grade) {
      const med3Block = document.getElementById('med3Block');
      const med4Block = document.getElementById('med4Block');
      const med5Block = document.getElementById('med5Block');
      const med6Block = document.getElementById('med6Block');
      const med3Btn = document.getElementById('med3Btn');
      const med4Btn = document.getElementById('med4Btn');
      const med5Btn = document.getElementById('med5Btn');
      const med6Btn = document.getElementById('med6Btn');
      
      // éš±è—æ‰€æœ‰å€å¡Š
      med3Block.style.display = 'none';
      med4Block.style.display = 'none';
      med5Block.style.display = 'none';
      med6Block.style.display = 'none';
      
      // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
      med3Btn.classList.remove('active');
      med4Btn.classList.remove('active');
      med5Btn.classList.remove('active');
      med6Btn.classList.remove('active');
      
      // æ ¹æ“šé¸æ“‡é¡¯ç¤ºå°æ‡‰å€å¡Šå’ŒæŒ‰éˆ•ç‹€æ…‹
      if (grade === 'med3') {
        med3Block.style.display = 'block';
        med3Btn.classList.add('active');
      } else if (grade === 'med4') {
        med4Block.style.display = 'block';
        med4Btn.classList.add('active');
      } else if (grade === 'med5') {
        med5Block.style.display = 'block';
        med5Btn.classList.add('active');
      } else if (grade === 'med6') {
        med6Block.style.display = 'block';
        med6Btn.classList.add('active');
      }
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–é¦–é åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        updateHomepageVisualizationButton();
        updateVisualizationButtonState();
      }, 100);
    });

</script>

  <!-- åœ–ç‰‡æ”¾å¤§é¡¯ç¤ºè¦†è“‹å±¤ -->
  <div class="image-overlay" id="imageOverlay" onclick="closeImageOverlay()">
    <img id="overlayImage" src="" alt="æ”¾å¤§åœ–ç‰‡">
  </div>

  <!-- è¦–è¦ºåŒ–å½ˆå‡ºè¦–çª— -->
  <div class="visualization-modal" id="visualizationModal">
    <div class="visualization-content">
      <div class="visualization-header">
        <h2>ğŸ“Š ç­”é¡Œç‹€æ³è¦–è¦ºåŒ–åˆ†æ</h2>
        <button class="close-visualization" onclick="closeVisualization()">âœ•</button>
      </div>
      <div class="visualization-body" id="visualizationBody">
        <div id="visualizationContent">
          <!-- è¦–è¦ºåŒ–å…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>

</body>
</html>
